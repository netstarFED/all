<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网星工作台-组织机构</title>
    <!--#include file="public/htmlhead.html"-->

    <style>

    </style>
</head>

<body>

    <!-- 头部内容 -->
    <div class="contianer-fluid">
        <div class="row">
            <!--#include file="public/header.html"-->
        </div>
    </div>
    <!-- 内容部分 -->
    <div class="container">
        <div class="row">
            <div class="main">
                <div class="main-row">
                    <!-- 页面左侧内容 -->
                    <div class="main-col">
                        <!-- 用户信息 -->
                        <div class="panel">
                            <!--#include file="public/user-info.html"-->
                        </div>
                        <!-- 左侧导航 -->
                        <div class="panel">
                            <!--#include file="public/nav.html"-->
                        </div>
                    </div>
                    <div class="main-col">
                        <!-- 表格 -->
                        <div class="panel organization">
                            <div class="table">
                                <!-- 表格头部 -->
                                <div class="table-header">
                                    <div class="title">
                                        <span>组织机构</span>
                                    </div>
                                    <div class="form form-inline">
                                        <form action="">
                                            <div class="form-item">

                                                <div class="radio radiobox">
                                                    <label class="radio-item current">
                                                        <input type="radio" name="optionsRadios" id="optionsRadios1"
                                                            value="option1" checked>
                                                        启用
                                                    </label>
                                                    <label class="radio-item">
                                                        <input type="radio" name="optionsRadios" id="optionsRadios2"
                                                            value="option2">
                                                        禁用
                                                    </label>
                                                </div>

                                            </div>
                                            <div class="form-item search-box">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" placeholder="账号/姓名/岗位/手机号">
                                                    <div class="input-group-btn">
                                                        <button class="btn btn-primary btn-outline btn-icon">
                                                            <i class="icon-search"></i>
                                                        </button>
                                                        <button class="btn btn-primary btn-outline">
                                                            <span>高级查询</span>
                                                        </button>
                                                    </div>
                                                </div>

                                            </div>
                                        </form>

                                    </div>
                                </div>
                                <!-- 表格内容 -->
                                <div class="table-body" id="org-information">
                                    <!-- <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>账号</th>
                                                <th>姓名</th>
                                                <th>岗位</th>
                                                <th>手机号</th>
                                                <th>状态</th>
                                                <th>角色</th>
                                                <th>超期</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="value in orgList">
                                                <td>
                                                     <input class="org-check" type="checkbox">
                                                    <el-checkbox v-model="checked">备选项</el-checkbox>
                                                </td>
                                                <td>{{value.account}}</td>
                                                <td>{{value.userName}}</td>
                                                <td>{{value.postId}}</td>
                                                <td>{{value.mobile}}</td>
                                                <td>{{value.state}}</td>
                                                <td>{{value.roleId}}</td>
                                                <td>{{value.state}}</td>
                                                <td>
                                                    <a href="" v-on:click="deleteRow">删除</a>
                                                    <a href="" v-on:click="resetPwd">重置密码</a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table> -->
                                    <template>
                                        <el-table :data="tableData" style="width: 100%" max-height="483"
                                            @row-click="clickRow" @select="handleSelectionChange">
                                            <el-table-column type="selection" width="30 ">
                                            </el-table-column>
                                            <el-table-column prop="account" label="账号" width="60">
                                            </el-table-column>
                                            <el-table-column prop="userName" label="姓名" width="80" height="200">
                                            </el-table-column>
                                            <el-table-column prop="postId" label="岗位" width="60">
                                            </el-table-column>
                                            <el-table-column prop="mobile" label="手机号" width="120">
                                            </el-table-column>
                                            <el-table-column prop="address" label="角色" width="150">
                                            </el-table-column>
                                            <el-table-column prop="state" label="超期" width="120">
                                            </el-table-column>
                                            <el-table-column fixed="right" label="操作" width="120">
                                                <template slot-scope="scope">
                                                    <el-button @click="deleteRow(scope.$index,tableData)" type="text"
                                                        size="small">
                                                        删除</el-button>
                                                    <el-button @click="resetPwd(scope.$index,tableData)" type="text"
                                                        size="small">
                                                        重置密码</el-button>
                                                </template>
                                            </el-table-column>
                                        </el-table>
                                    </template>
                                </div>
                                <script>
                                    var organizationVm = {
                                        data() {
                                            return {
                                                tableData: [],
                                                multipleSelection: [],
                                                checkedRows: [],
                                                checkedRowData: {}
                                            }
                                        },
                                        methods: {
                                            handleClick: function () {

                                            },
                                            lickOn(row) {},
                                            toggleSelection(rows) {

                                            },
                                            //获取勾选数据
                                            handleSelectionChange(checkRows, checkedRowData) {
                                                var _this = this
                                                _this.checkedRows = checkRows;
                                                _this.checkedRowData = checkedRowData
                                                /*    debugger;
                                                 */
                                            },
                                            //选中行
                                            clickRow(row, column) {
                                                var id = row.id
                                                var _this = this
                                                //_this.deleteRow(row, column, id)  
                                            },
                                            details: function () {},
                                            /* 操作列删除 ajaxData为表格行id */
                                            deleteRow: function (index, rows) {
                                                var _this = this
                                                _this.$confirm('此操作将永久删除该用户, 是否继续?', '提示', {
                                                    confirmButtonText: '确定',
                                                    cancelButtonText: '取消',
                                                    type: 'warning'
                                                }).then(function () {
                                                    //确定删除
                                                    var id = rows[index].id
                                                    var _this = this;
                                                    rows.splice(index, 1);
                                                    axios(NswUtils.getAxios({
                                                        url: '/system/users/delById',
                                                        method: 'POST',
                                                        contentType: 'application/x-www-form-urlencoded',
                                                        data: {
                                                            id: id
                                                        }
                                                    })).then(function (res) {
                                                        _this.$message({
                                                            message: '删除成功',
                                                            type: 'success'
                                                        });
                                                    }).catch(function (error) {
                                                        _this.$message({
                                                            message: '操作失败',
                                                            type: 'error'
                                                        });
                                                        console.error(error);
                                                    })
                                                }).catch(function () {
                                                    //取消删除动作
                                                })

                                            },
                                            //重置密码
                                            resetPwd: function () {
                                                axios(NswUtils.getAxios({
                                                    url: '/system/users/resetPwd',
                                                    method: 'POST',
                                                    data: {}
                                                })).then(function (res) {

                                                }).catch(function (error) {
                                                    console.error(error);
                                                })
                                            }
                                        },
                                        mounted() {
                                            /*  表格数据 ajaxData 树节点code  */
                                            var _this = this;
                                            var ajaxData =store.get('MyServiceUserInfo').userInfo.orgCode;
                                                axios(NswUtils.getAxios({
                                                    method: 'POST',
                                                    url: '/system/users/getList',
                                                    data: {
                                                        deptCode: ajaxData,
                                                    }
                                                }))
                                                .then(function (res) {
                                                    var data = res.data.rows
                                                    for (i = 0; i < data.length; i++) {
                                                        if (data[i].state == '2') {
                                                            data[i].state = '正常'
                                                        } else if (data[i].state == '-1') {
                                                            data[i].state = '删除'
                                                        } else if (data[i].state == '1') {
                                                            data[i].state = '已过期'
                                                        } else if (data[i].state == '0') {
                                                            data[i].state = '已注销'
                                                        }
                                                    }

                                                    _this.tableData = data

                                                })
                                                .catch(function (error) {
                                                    console.error(error);
                                                });
                                        }
                                    }
                                    var Ctor = Vue.extend(organizationVm)
                                    var organizationVue = new Ctor().$mount('#org-information')
                                </script>
                                <div class="table-footer" id="org-state-btn">
                                    <div class="btn-group">
                                        <button class="btn btn-primary btn-outline">
                                            <span>新增</span>
                                        </button>
                                        <button class="btn btn-primary btn-outline">
                                            <span>维护</span>
                                        </button>
                                        <button v-on:click='allDelete' class="btn btn-primary btn-outline">
                                            <span>删除</span>
                                        </button>
                                        <button class="btn btn btn-primary btn-outline">
                                            <span>人员调动</span>
                                        </button>
                                        <button class="btn btn btn-primary btn-outline">
                                            <span>设置角色</span>
                                        </button>

                                    </div>
                                </div>
                            </div>
                            <script>
                                var buttonVm = new Vue({
                                    el: '#org-state-btn',
                                    methods: {
                                        allDelete: function () {
                                            var _this = this;
                                            var checkedRows = organizationVue.checkedRows;
                                            if (checkedRows.length == 0) {
                                                _this.$message({
                                                    message: '未选中数据，无法删除',
                                                    type: 'error'
                                                });
                                                return;
                                            }

                                            _this.$confirm('此操作将永久删除该用户, 是否继续?', '提示', {
                                                confirmButtonText: '确定',
                                                cancelButtonText: '取消',
                                                type: 'warning'
                                            }).then(function () {
                                                //确定
                                                var checkeds = {};
                                                var idArr = [];
                                                for (var i = 0; i < checkedRows.length; i++) {
                                                    idArr.push(checkedRows[i].id);
                                                }
                                                var ids = idArr.join(',');
                                                axios(NswUtils.getAxios({
                                                    url: '/system/users/delByIds',
                                                    contentType: 'application/x-www-form-urlencoded',
                                                    method: 'POST',
                                                    data: {
                                                        ids: ids
                                                    }
                                                })).then(function (res) {
                                                    if (res.data.success) {
                                                        var deleteLength = organizationVue
                                                            .checkedRows.length;
                                                        _this.$message({
                                                            message: '已选中数据（共' +
                                                                deleteLength +
                                                                '条）删除成功',
                                                            type: 'success'
                                                        });
                                                        //成功后从列表中删除
                                                        var allRows = organizationVue
                                                            .tableData;
                                                        var checkedRows = organizationVue
                                                            .checkedRows;
                                                        NswUtils.deleteArrayByArray(allRows,
                                                            checkedRows);
                                                    }
                                                }).catch(function (error) {
                                                    console.error(error);
                                                })

                                            }).catch(function () {
                                                //取消
                                            })

                                            return;

                                        },

                                    },
                                    mounted() {

                                    }
                                })
                            </script>
                            <!-- 分支机构 -->
                            <div class="tree">
                                <div class="tree-header">
                                    <button class="btn btn-primary btn-outline btn-icon">
                                        <i class="icon icon-edit"></i>
                                    </button>
                                </div>
                                <div class="tree-body">

                                    <div id="org-tree">
                                        <el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick">
                                        </el-tree>
                                    </div>
                                    <script>
                                        var orgTreeVm = {
                                            data() {
                                                return {
                                                    data: [],
                                                    defaultProps: {
                                                        children: 'children',
                                                        label: 'name'
                                                    },
                                                    selectTreeId: ''
                                                };
                                            },
                                            methods: {
                                                handleNodeClick(data) {
                                                    debugger;
                                                    var _this = this;
                                                    var selectTreeId = data.code
                                                    _this.selectTreeId = selectTreeId
                                                }
                                            },
                                            mounted() {
                                                var _this = this;
                                                axios(NswUtils.getAxios({
                                                        method: 'POST',
                                                        url: '/system/orgs/getList',
                                                        data: {}
                                                    }))
                                                    .then(function (res) {
                                                        var data = res.data.rows
                                                        console.log(_this);

                                                        _this.data = NswUtils.getTreeByList(data, 'id',
                                                            'parentId', 'children', 'id');
                                                    })
                                                    .catch(function (error) {
                                                        console.error(error);
                                                    });
                                            }
                                        };
                                        var Ctor = Vue.extend(orgTreeVm)
                                        var orgTreeVue = new Ctor().$mount('#org-tree')
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>