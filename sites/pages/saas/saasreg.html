<!--
 * @Description: In User Settings Edit
 * @Author: 祁倩
 * @Date: 2020-2-13 10:30
 * @LastEditTime: 2020-2-13 10:30
 * @LastEditors: Please set LastEditors
 -->
<!--# include file="/sites/docs/include/homepage-html-dev-1.html" -->
<script src="https://qa.wangxingcloud.com/static/libs/axios.min.js"></script>
<style>

</style>
<container>
    <div class="pt-main">
        <div class="pt-container">
            <div id="netstar-saas-reg-btns"></div>
            <div class="pt-main-row">
                <!-- left -->
                <div class="pt-main-col" id="saasreg">
                    <!-- 用户照片 -->
                    <div class="pt-panel">
                        <div class="search-box">
                            <input type="text" class="pt-form-control" placeholder="体检编号" @blur.prevent='searchNo()'>
                        </div>
                    </div>
                    <div class="pt-panel">
                        <div class="user-photo">
                            <img src="../saas/static/images/user-photo.jpg" alt="">
                        </div>
                        <div class="user-photo-eidt">
                            <div class="pt-btn-group">
                                <button class="pt-btn pt-btn-default">
                                    <i class="icon icon-image"></i>
                                </button>
                                <button class="pt-btn pt-btn-default">
                                    <i class="icon icon-id"></i>
                                </button>
                                <button class="pt-btn pt-btn-default">
                                    <i class="icon icon-camera"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 用户照片 end-->
                    <!-- 排队 -->

                    <div class="pt-panel">
                        <div class="queue">
                            <div class="list">
                                <a class="list-item" href="#">
                                    <i class="fa fa-venus"></i>
                                    <span>王晓霖</span>
                                    <div class="list-after">
                                        <i class="icon icon-arrow-top-o"></i>
                                    </div>
                                </a>
                                <a class="list-item" href="#">
                                    <i class="fa fa-mars"></i>
                                    <span>张文远</span>
                                    <div class="list-after">
                                        <i class="icon icon-user"></i>
                                    </div>
                                </a>
                                <a class="list-item" href="#">
                                    <i class="fa fa-mars"></i>
                                    <span>宋文涛</span>
                                    <div class="list-after">
                                        <i class="icon icon-arrow-down-o"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- 排队 end -->
                    <!-- 报价单 -->
                    <div class="pt-panel">
                        <!-- 报价单 类型-->
                        <!--  <div class="price-block">
                                <div class="price-block-header">
                                    <span class="price-type price-type-public" :class = ""
                        >公费</span>
                                    <span></span>
                                </div>
                                <div class="price-block-body">
                                    <ul>
                                        <li>
                                            <label for="">标准价格：</label>
                                            <span>￥99.00</span>
                                        </li>
                                        <li>
                                            <label for="">优惠券：</label>
                                            <span>￥99.00</span>
                                        </li>
                                        <li>
                                            <label for="">实收金额：</label>
                                            <span><b>￥99.00</b></span>
                                        </li>
                                    </ul>
                                </div>
                            </div> -->
                        <!-- 报价单 已付款-->
                        <div class="price-block" v-for="item in regPricingVOList" :class="{'price-paid':isChargeStyle}">
                            <div class="price-block-header">
                                <span class="price-type"
                                    :class="{'price-type-public':isPublicExpense,'price-type-own':isOwnExpenseStyle}">{{item.isOwnExpense}}</span>
                                <span>{{item.pricingCode}}</span>
                            </div>
                            <div class="price-block-body">
                                <ul>
                                    <li>
                                        <label for="">标准价格：</label>
                                        <span>{{item.standardAmount}}</span>
                                    </li>
                                    <li>
                                        <label for="">优惠券：</label>
                                        <span>{{item.discountAmount}}</span>
                                    </li>
                                    <li>
                                        <label for="">实收金额：</label>
                                        <span><b>{{item.amount}}</b></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- 报价单 end -->
                    <!-- 优惠券 -->
                    <div class="pt-panel">
                        <div class="card-group">
                            <div class="card-list">
                                <div class="card">
                                    <div class="card-before">
                                        <span>优惠券</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="card-content">
                                            <div class="card-title">
                                                <h4>￥100</h4>
                                            </div>
                                            <div class="card-text">
                                                2020年6月30日
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-after">
                                        <button class="pt-btn pt-btn-default">
                                            <span>去使用</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-list">
                                <div class="card card-checked">
                                    <div class="card-before">
                                        <span>优惠券</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="card-content">
                                            <div class="card-title">
                                                <h4>￥100</h4>
                                            </div>
                                            <div class="card-text">
                                                2020年6月30日
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-after">
                                        <i class="icon icon-check-circle"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 优惠券 end-->
                </div>
                <!-- center -->
                <div class="pt-main-col">
                    <div class="pt-panel" id="netstar-saas-register">
                        <div class="pt-panel-header">
                            <div class="title">体检登记</div>
                            <div class="pt-panel-header-right">
                                <span>预约时间：{{time}}</span>
                                <span>订单编号：{{orderNo}}</span>
                                <div class="switch">
                                    <div class="switch-item" v-on:click="btnCutaways"
                                        :class="{'current': isbtnCutaways==0}">
                                        <span>个人</span>
                                    </div>
                                    <div class="switch-item" v-on:click="btnCutawaysBack"
                                        :class="{'current': isbtnCutaways==1}">
                                        <span>单位</span>
                                    </div>
                                </div>
                                <div class="checkbox-box" v-on:click="btnChecked" :class="{'checked': ischecked==true}">
                                    <span>预约</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="netstar-saas-reg-vo"></div>
                    <div class="pt-panel">
                        <div class="pt-panel-header" id="netstar-saas-hazard">
                            <div style="display: flex;">
                                <div class="title" style="margin-top: 14px;margin-right: 5px;padding-top: 2px;">职业危害因素
                                </div>
                                <!-- 搜索 -->
                                <div style="padding: 14px 43% 10px 0;" class="pt-panel-col">
                                    <div class="pt-form pt-form-normal pt-form-inline pt-custom-query"
                                        style="min-height: 24px;">
                                        <div class="pt-form-header"></div>
                                        <div class="pt-form-body">
                                            <form>
                                                <div ns-type="field" class="field">
                                                    <div ns-field="filtermode" class="pt-form-group fg-select ">
                                                        <label class="pt-control-label hide"></label>
                                                        <div class="pt-select pt-input-group">
                                                            <input type="text" placeholder="" selectmode="single"
                                                                ns-id="filtermode" class="pt-form-control"
                                                                style="width: 150px;">
                                                            <div class="pt-input-group-btn">
                                                                <button class="pt-btn pt-btn-default pt-btn-icon clear">
                                                                    <i class="icon-close"></i>
                                                                </button>
                                                                <button class="pt-btn pt-btn-default pt-btn-icon">
                                                                    <i class="icon-arrow-down-o"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div ns-field="filterstr" class="pt-form-group fg-text ">
                                                        <label class="pt-control-label hide"></label>
                                                        <div class="pt-text pt-input-group pt-text-assistant">
                                                            <input type="text" placeholder="" class="pt-form-control"
                                                                style="width: 150px;">
                                                            <div class="pt-input-group-btn pt-input-group-btn-group">
                                                                <button
                                                                    class="pt-btn pt-btn-default pt-btn-icon pt-input-clear hide">
                                                                    <i class="icon-close"></i>
                                                                </button></div>
                                                            <div class="pt-text-assistant-btns hide">
                                                                <div class="pt-btn-group"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div ns-type="field-more" class="field-more hide custom"></div>
                                            </form>
                                        </div>
                                        <div class="pt-form-footer"></div>
                                    </div>
                                    <div class="pt-btn-group"><button type="button"
                                            class="pt-btn pt-btn-default pt-btn-icon" nstype="refresh"><i
                                                class="icon-search"></i></button></div>
                                </div>
                                <!-- 搜索end -->
                                <div id="netstar-saas-reg-hazard-btns" style="padding:14px 0px 10px 0"></div><!-- 按钮 -->
                            </div>

                            
                            <div v-for="(list,index) in regHazardVOList">
                                <div style="float: left; padding-right: 10px;padding-bottom: 10px;width: 20%;">
                                    <div style="width:100%;height:70px;border: 1px solid #bfbfbf;">
                                        <!-- <select>
                                            <option v-for="list in occTutelagesList" value="list.id">{{list.tutelageName}}
                                            </option>
                                        </select>
                                        <select>
                                            <option v-for="list in occHazardsList" value="list.id">{{list.hazardName}}
                                            </option>
                                        </select> -->
                                        <div style="padding: 10px;">
                                            <div @click="clickTdHandler($event, list.hazardId, 'hazardName', index, list.hazardDomId)">
                                                <span>{{list.hazardName}}</span>
                                                <div :id = "list.hazardDomId" class="form-block-editor-container"></div>
                                            </div>
                                            <div @click="clickTdHandler($event, list.ocpcId, 'ocpcName', index, list.ocpcDomId)">
                                                <span>{{list.ocpcName}}</span>
                                                <div :id = "list.ocpcDomId" class="form-block-editor-container"></div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- 图片上传 -->
                </div>
                <div class="pt-main-col">
                    <!-- 体检项目 -->
                    <div class="pt-panel">
                        <div class="pt-panel-header">
                            <div class="pt-btn-group">
                                <button class="pt-btn pt-btn-default pt-btn-icon" onclick="javascript:addCombo()"
                                    id="netstar-saas-reg-addCombo-dialog">
                                    <i class="icon icon-add"></i>
                                </button>
                                <button class="pt-btn pt-btn-default" @click="clearAllItem()">
                                    <span>清空</span>
                                </button>
                                <button class="pt-btn pt-btn-default">
                                    <span>计算价格</span>
                                </button>
                                <button class="pt-btn pt-btn-default">
                                    <span>项目详情</span>
                                </button>
                            </div>
                            <div class="badge">
                                <span>项目数量</span>
                                <span class="pt-badge pt-badge-warning">
                                    {{itemAmountNum}}
                                </span>
                            </div>
                        </div>
                        <div class="pt-panel-body">
                            <div class="block-list block-list-vertical">
                                <div class="block-list-group">
                                    <div class="block-list-item " v-for='item in addComboVOList'>
                                        <div class="block-list-content">
                                            <div class="list-body">
                                                <div class="list-title">
                                                    <span>{{item.comboName}}</span>
                                                </div>
                                                <div class="list-text">
                                                    <span>{{item.receivable}}</span><!-- 实收金额 -->
                                                    <span class="text-through">{{item.standardAmount}}</span>
                                                </div>

                                            </div>
                                            <div class="block-list-control">
                                                <div class="pt-btn-group">
                                                    <button class="pt-btn pt-btn-default pt-btn-icon"
                                                        @click="addItemFun(item.comboId)">
                                                        <i class="icon">
                                                            自
                                                        </i>
                                                    </button>
                                                    <button class="pt-btn pt-btn-default pt-btn-icon"
                                                        @click="deleteItem(item.comboId)">
                                                        <i class="icon icon-trash-o"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="price-type-mark" v-if="item.isOwnExpense === 0">
                                                自
                                            </div>
                                            <div class="program-addon-mark" v-if="item.packageId">
                                                +
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 体检项目 end-->
                </div>
            </div>
        </div>
    </div>
    <script>
        var getRootPath = function () {
            return 'https://qaapi.wangxingcloud.com/'
        };
        var saasReg = new Vue({
            el: '#saasreg',
            data: {
               
                isOwnExpense: true,
                itemAmountNum: '0', //项目数量
                isOwnExpenseItem: true, //项目列表是否自费的显示隐藏
                addItem: true, //项目列表加项目的显示隐藏
                isChargeStyle: true, //是否已收费样式
                isOwnExpenseStyle: false, //自费样式--
                isPublicExpense: true, //公费样式
                regPricingVOList: [ //划价单vo
                    /*{
                          isOwnExpense:'自费',//缴费类型
                          pricingCode:'20200325354688',//编号
                          standardAmount:'',//标准价格
                          discountAmount:'',//优惠券
                          amount:''//实收金额
                      },*/
                ],
                regCouponVOList: [ //登记使用优惠券
                    /*{
                        "couponType": "银行卡",//券类型  number
                        "parValue": 100, //面值   number
                    } */

                ],

                addComboVOList: [ //登记添加项目VO集合

                ],
                occTutelagesList: [

                ],
                occHazardsList: [

                ],
                regHazardVOList: [ //职业危害
                ]

            },
            methods: {
              
                //自费与加项的显示与隐藏
                itemShowOrHidden: function () {
                    var _this = this;
                    for (var i = 0; i < _this.addComboVOList.length; i++) {
                        if (_this.addComboVOList[i].packageId) {
                            _this.addItem = true
                        } else {
                            _this.addItem = false
                        }

                        if (_this.addComboVOList[i].isOwnExpense == '1') {
                            _this.isOwnExpenseItem = false
                        } else if (_this.addComboVOList[i].isOwnExpense == '0') {
                            _this.isOwnExpenseItem = true
                        }
                    }
                },
                //删除项目
                deleteItem(itemId) {
                    var _this = this;
                    for (var i = 0; i < _this.addComboVOList.length; i++) {
                        if (_this.addComboVOList[i].comboId == itemId) {
                            _this.addComboVOList.splice(i, 1);
                            var itemLength = _this.addComboVOList.length;
                            _this.itemAmountNum = itemLength;
                        }
                    }
                },
                //自费
                addItemFun(itemId) {
                    debugger;
                    var _this = this;
                    for (var i = 0; i < _this.addComboVOList.length; i++) {
                        if (_this.addComboVOList[i].comboId == itemId) {
                            _this.addComboVOList[i].isOwnExpense = 0;
                        }
                    }
                },
                //项目数量
                itemAmount() {
                    var _this = this;
                    var length = _this.addComboVOList.length;
                    console.log('项目数量', length);
                    _this.itemAmountNum = length

                },
                //清空项目按钮
                clearAllItem() {
                    var _this = this;
                    _this.addComboVOList = [];
                    _this.itemAmountNum = "0";
                },
                //搜索体检编号(失去焦点搜索)
                searchNo() {
                    debugger;
                    var data = $('.pt-form-control').val();
                    var ajaxConfig = {
                        url: getRootPath() + '/reg/regs/getByRegCode',
                        contentType: 'application/x-www-form-urlencoded',
                        /* contentType: 'application/json', */
                        data: {
                            regCode: data,
                            params: ['regType', 'regCombo'],
                        },
                        type: 'POST',
                    }
                    NetStarUtils.ajax(ajaxConfig, function (res) {

                    })
                },
                //职业危害
                
            },
            mounted() {
                var _this = this;
                axios.get('/sites/pages/saas//getById.json').then(function (data) {
                    /* debugger; */
                    console.log(data.data.data)
                    var data = data.data.data;
                    var regPricingVOList = data.regPricingVOList; //划价单vo
                    var regCouponVOList = data.regCouponVOList; //登记使用优惠券
                    var regHazardVOList = data.regHazardVOList; //职业危害
                    //划价单vo数据处理 isOwnExpense/0/公费  1/自费
                    /* --是否付费处理 */
                    for (var regPricingI = 0; regPricingI < regPricingVOList.length; regPricingI++) {
                        if (regPricingVOList[regPricingI].isOwnExpense == 1) {
                            regPricingVOList[regPricingI].isOwnExpense = "自费"
                        }
                        if (regPricingVOList[regPricingI].isOwnExpense == 0) {
                            regPricingVOList[regPricingI].isOwnExpense = "公费"
                        }
                    }
                    for(var regHazardI = 0; regHazardI <regHazardVOList.length; regHazardI++){
                        regHazardVOList[regHazardI].hazardDomId = "hazardDomId-" + regHazardI;
                        regHazardVOList[regHazardI].ocpcDomId = "ocpcDomId-" + regHazardI;
                    }
                    _this.regPricingVOList = regPricingVOList;
                    _this.regCouponVOList = regCouponVOList;
                    _this.regHazardVOList = regHazardVOList;
                    

                }).catch(function (error) {

                });
                var ajaxConfig = { //监护种类
                    url: getRootPath() + '/npebase/occTutelages/getList',
                    contentType: 'application/json',
                    data: {},
                    type: 'POST',
                }
                var occAjaxConfig = {
                    url: getRootPath() + '/npebase/occHazards/getList', //危害
                    contentType: 'application/json',
                    data: {},
                    type: 'POST',
                }
        /*         NetStarUtils.ajax(occAjaxConfig, function (res) {

                })
                NetStarUtils.ajax(ajaxConfig, function (res) {

                }) */

            }

        })
        //登记
        var registerVue = new Vue({
            el:'#netstar-saas-register',
            data:{
                time: '2020年2月18日', //预约时间
                orderNo: "20202187968545265", //订单编号
                isbtnCutaways: 0, //个人单位切换
                ischecked: true, //预约勾选
            },
            methods:{
                  //体检登记  单位个人切换
                  btnCutaways: function () {
                    var _this = this;
                    console.log(_this)
                    _this.isbtnCutaways = 0
                },
                btnCutawaysBack: function () {
                    var _this = this;
                    _this.isbtnCutaways = 1
                },
                //体检登记 预约勾选
                btnChecked: function () {
                    var _this = this;
                    console.log(_this);
                    if (_this.ischecked) {
                        _this.ischecked = false;
                    } else {
                        _this.ischecked = true;
                    }
                },
            }
        })
        //危害
        
        var harmAjax = {
            url: 'http://localhost:2000//sites/pages/saas/getById.json', //危害
            contentType: 'application/x-www-form-urlencoded',
            data: {},
            type: 'GET',
        }
        //职业危害
        var harmConfig = {
            field : [
                {
                    field:'ocpcName',
                    editConfig:{
                        type:'select',
                        url:getRootPath() + '/npebase/occTutelages/getList',
                        contentType:'application/json',
                        mentod:'POST',
                        dataSrc:'rows',
                        valueField:'id',
                        textField:'tutelageName',
                        outputFields : {
                            ocpcName : '{tutelageName}',
                            ocpcId: '{id}',
                        },
                    }
                },
                {
                    field:'hazardName',
                    editConfig:{
                        type:'select',
                        url:getRootPath() + '/npebase/occHazards/getList',
                        contentType:'application/json',
                        mentod:'POST',
                        dataSrc:'rows',
                        valueField:'id',
                        textField:'hazardName',
                        outputFields : {
                            hazardName : '{hazardName}',
                            hazardId: '{id}',
                        },
                    }
                }
            ],
            componentById : {
                ocpcName : {
                    editConfig : {
                        type:'select',
                        url:getRootPath()+'/npebase/occTutelages/getList',
                        contentType:'application/json',
                        mentod:'POST',
                        dataSrc:'rows',
                        valueField:'id',
                        textField:'tutelageName',
                        outputFields : {
                            ocpcName : '{tutelageName}',
                            ocpcId: '{id}',
                        },
                    }
                },
                hazardName : {
                    editConfig : {
                        type:'select',
                        url:getRootPath() + '/npebase/occHazards/getList',
                        contentType:'application/json',
                        mentod:'POST',
                        dataSrc:'rows',
                        valueField:'id',
                        textField:'hazardName',
                        outputFields : {
                            hazardName : '{hazardName}',
                            hazardId: '{id}',
                        },
                    }
                }
            }
        }
        NetStarUtils.ajax(harmAjax, function (res) {
            var data = res.data;
            var regHazardVOList = data.regHazardVOList; //职业危害
            for(var regHazardI = 0; regHazardI<regHazardVOList.length; regHazardI++){
                regHazardVOList[regHazardI].hazardDomId = "hazardDomId-" + regHazardI;
                regHazardVOList[regHazardI].ocpcDomId = "ocpcDomId-" + regHazardI;
            }
            var harmVue = new Vue({
                el:'#netstar-saas-hazard',
                data:{
                    regHazardVOList : regHazardVOList
                },
                methods:{
                    removeComponent:function($editorContainer){
                        if ($editorContainer.length > 0) {
                            var editorConfig = this.editorConfig;
                            var editorVueConfig = this.editorVue;
                            var editorVueComConfig = false;
                            if(editorVueConfig){
                                editorVueComConfig = editorVueConfig.$children[0];
                            }
                            /******lyw 20190411 计算器组件需要重新获取，进行保存值 end********/
                            // 验证是否是日期组件 删除日器组件
                            if(typeof(editorConfig) == "object"){
                                switch(editorConfig.type){
                                    case 'date':
                                        break;
                                    case 'provinceselect':
                                        break;
                                    case 'select':
                                        if(editorVueComConfig){
                                            if(editorConfig.panelVueObj){
                                                $(document).off("click", editorConfig.panelVueObj.isSearchDropDown);
                                            }
                                            if(typeof(editorVueComConfig.blurHandler)=='function'){
                                                editorVueComConfig.blurHandler();
                                            }
                                        }  
                                        break;
                                }
                            }
                            // 销毁组件
                            if(typeof(editorVueConfig) == "object"){
                                editorVueConfig.$destroy();
                                delete this.editorVue;
                            }
                            this.removeRemoveEditorListener();
                            $editorContainer.children().remove();
                            if ($('.pt-select-panel').length > 0) {
                                // 下拉组件下拉框删除 以及下拉框添加的事件关闭
                                $('.pt-select-panel').remove();
                                $(document).off('keyup',NetstarComponent.select.panelComponentConfig.keyup);
                            }
                        }
                    },S
                    removeRemoveEditorListener : function(){
                        $('body').off('mousedown', this.outClickHandler);
                    },
                    outClickHandler:function(ev){
                        //如果当前操作对象不再编辑器里则是out
                        var isOut = $(ev.target).closest('.form-block-editor-container').length == 0;
                        if (isOut) {
                            if (ev.target.nodeName == 'LI') {
                                isOut = false;
                            }

                            //sjj 2019106  如果当前下拉框出现滚动区域不可关闭
                            if (ev.target.className == 'pt-dropdown') {
                                if (ev.target.parentNode && ev.target.parentNode.className.indexOf('pt-input-group pt-select-panel')>-1){
                                    isOut = false;
                                }
                            }
                            if($(ev.target).closest('.pt-pager').length == 1){
                                //sjj 20200113
                                isOut = false;
                            }
                        }
                        //如果当前操作也不在要点击的单元格里则不是out
                        var $td = ev.data.$td;
                        if ($td[0] == $(ev.target)[0] || $(ev.target).closest('td')[0] == $(ev.target)[0] || $td[0] == $(ev.target).closest('td')[0]) {
                            isOut = false;
                        }
                        var _tdEditor = ev.data.this;
                        if (isOut) {
                            var $gridContainer = ev.data.$td.closest('container');
                            if ($gridContainer.length == 0) {
                                $gridContainer = $('body');
                            }
                            var $editorContainer = $gridContainer.find('.form-block-editor-container');
                            _tdEditor.removeComponent($editorContainer);
                        }
                    },
                    addRemoveListener : function($td){
                        //$td是当前点击正在初始化的单元格
                        var _this = this;
                        //点击了其他地方的监听器
                        this.removeRemoveEditorListener();
                        //sjj 20190509 把body的click事件改为了mousedown事件
                        $('body').on('mousedown', {
                            this: _this,
                            $td: $td
                        }, this.outClickHandler);
                    },
                    showFormEditor : function(ev, editConfig, fieldName, index, hazardDomId){
                        var _this = this;
                        var $td = $(ev.currentTarget);
                        var editConfig = editConfig;
                        editConfig.changeHandler = function(obj){
                            var editValue = obj.vueConfig.getValue();
                            // 赋值
                            if(typeof(editValue) == "object"){
                                for(var key in editValue){
                                    _this.regHazardVOList[index][key] = editValue[key];
                                }
                            }else{
                                _this.regHazardVOList[index][fieldName] = editValue;
                            }
                            // 移除 
                            var $editorContainer = $('#' + hazardDomId);
                            _this.removeComponent($editorContainer);
                        }
                        var componentVueConfig = NetstarComponent[editConfig.type].getComponentConfig(editConfig);
                        var editorVueConfig = {
                            el: '#' + hazardDomId,
                            data: {
                            },
                            components: {
                                'editorinput': componentVueConfig
                            }
                        };
                        NetstarComponent.config[editConfig.formID] = {
                            vueConfig: {},
                            config: {},
                            source : {
                                obj : {},
                            },
                        };
                        this.editConfig = editConfig
                        NetstarComponent.config[editConfig.formID].config[editConfig.id] = editConfig;
                        NetstarComponent.config[editConfig.formID].source.obj[editConfig.id] = editConfig;
                        this.editorVue = new Vue(editorVueConfig);
                        //聚焦并选中文本框
                        if (typeof (this.editorVue.$children[0]) == "object") {
                            NetstarComponent.config[editConfig.formID].config[editConfig.id].index = index;
                            this.editorVue.$children[0].focus();
                        }
                        NetstarComponent.config[editConfig.formID].vueConfig[editConfig.id] = this.editorVue.$children[0];
                        // 其他点击事件都会关闭编辑器
                        _this.addRemoveListener($td);
                    },
                    clickTdHandler(ev, value, fieldName, index, hazardDomId){

                        var $editContainer = $('#' + hazardDomId);
                        $editContainer.html('<editorinput></editorinput>')
                        var defaultComponentConfig = {
                            type:'select',
                            id: 'editor',
                            type: 'select',
                            formSource: 'table',
                            templateName: 'PC',
                            value: typeof (value) == "undefined" ? '' : value, // 当前单元格的value值。如果不存在设置“”
                            formID: 'netstar-saas-hazard',
                            variableType: 'string',
                            tableIndex: index,
                            isShowPanel : true,
                        }
                        var editConfig = harmConfig.componentById[fieldName].editConfig;
                        NsUtils.setDefaultValues(editConfig, defaultComponentConfig);
                        this.showFormEditor(ev, editConfig, fieldName, index, hazardDomId);
                    }
                },
                mounted(){
                }
            })
        })
        var pagesData = {
            addComboVOListData: '', //项目数据
            peTypeIdData: '',
            serverData: {}
        };
        var regId = {
            btns: 'netstar-saas-reg-btns',
            regHazardbtns: 'netstar-saas-reg-hazard-btns',
            voId: "netstar-saas-reg-vo",
            pricingBlockListId: "netstar-saas-reg-pricing-BlockList",
            hazardBlockListId: "netstar-saas-reg-hazard-BlockList",
            regcomboBlocklistId: 'netstar-saas-reg-regcombo-BlockList',
            regcombobtns: 'netstar-saas-reg-regcombobtns',
            regVoTop: 'netstar-saas-reg-vo-top',
            addComboDialogId: 'netstar-saas-reg-addCombo-dialog' //添加项目弹框Id


        }
        //体检登记vo
        var configs = {
            /* 按钮组 */
            regBtns: {
                id: regId.btns,
                btns: [{
                        text: '提交',
                        handler: function (data) {

                        }
                    },
                    {
                        text: '新增',
                        handler: function () {

                        }
                    },
                    {
                        text: '打印',
                        handler: function () {

                        }
                    },
                    {
                        text: '保存',
                        handler: function () {
                            debugger;
                            var formData = NetstarComponent.getValues(regId.voId);
                            if (!pagesData.addComboVOListData) {
                                pagesData.addComboVOListData = []
                            }
                            var ajaxData = {
                                params: ["regType", "regCombo"],
                                peState: 1, //体检状态
                                groupFlag: 0, //团体标志0个人1
                                regComboVOList: pagesData.addComboVOListData,
                                regTypeVOList: pagesData.peTypeIdData
                            };
                            var __ajaxData = $.extend(true, ajaxData, formData);
                            var idFieldNames = {
                                "root": "id",
                                "root.regComboVOList": "comboId",
                                "root.regTypeVOList": "peTypeId"
                            };
                            debugger;

                            var _ajaxData = nsServerTools.getObjectStateData(pagesData.serverData,
                                __ajaxData, idFieldNames)
                            var ajaxConfig = {
                                url: getRootPath() + '/reg/regs/save',
                                contentType: 'application/json',
                                data: _ajaxData,
                                type: 'POST',
                            }
                            NetStarUtils.ajax(ajaxConfig, function (res) {
                                var data = res.data;
                                if (res.success) {
                                    nsalert('保存成功');
                                    NetstarComponent.fillValues(data, regId.voId)
                                    pagesData.serverData = res.data;
                                }
                            })
                        }
                    },
                    {
                        text: '预览',
                        handler: function () {}
                    },
                    {
                        text: '保存草稿',
                        handler: function () {

                        }
                    },
                    {
                        text: '草稿箱',
                        handler: function () {

                        }
                    },
                    {
                        text: '流程查看',
                        handler: function () {

                        }
                    },
                    {
                        text: '撤回',
                        handler: function () {

                        }
                    },
                    {
                        text: '回退',
                        handler: function () {

                        }
                    },
                    {
                        text: '历史记录',
                        handler: function () {

                        }
                    }
                ]
            },
            regHazardbtns: {
                id: regId.regHazardbtns,
                btns: [{
                        text: '批量设置',
                        handler: function () {

                        }
                    },
                    {
                        text: '必检项目',
                        handler: function () {

                        }
                    }
                ]
            },
            // 项目按钮
            regcombobtns: {
                id: regId.regcombobtns,
                btns: [{
                        text: '清空',
                        handler: function () {

                        }
                    },
                    {
                        text: '计算项目',
                        handler: function () {

                        }
                    },
                    {
                        text: '查看详情',
                        handler: function () {

                        }
                    }
                ]
            },
            //体检登记vo
            regVo: {
                id: regId.voId,
                defaultComponentWidth: "33%",
                isSetMore: false,
                form: [{
                        id: "regCode",
                        label: '体检编号',
                        type: 'text'
                    },
                    {
                        id: 'peTypeId',
                        type: 'select',
                        label: '体检类别',
                        required: true,
                        url: getRootPath() + '/npebase/datPeClasss/getList',
                        contentType: 'application/json',
                        selectMode: 'multi',
                        mentod: 'POST',
                        dataSrc: 'rows',
                        valueField: 'id',
                        textField: 'name',
                        changeHandler: function (res) {
                            var idsStr = res.value;
                            var ajaxConfig = {
                                url: getRootPath() + 'reg/types/setPeType',
                                contentType: 'application/x-www-form-urlencoded',
                                type: 'POST',
                                dataSrc: 'rows',
                                data: {
                                    peTypeIds: idsStr,
                                }
                            }
                            NetStarUtils.ajax(ajaxConfig, function (res) {
                                if (res.success) {
                                    pagesData.peTypeIdData = res.rows
                                }
                            })
                        }
                    },
                    {
                        id: "idNo",
                        label: '证件类别',
                        type: 'select',
                        valueField: 'id',
                        textField: "name",
                        subdata: [{
                                id: '0',
                                name: '身份证'
                            },
                            {
                                id: '1',
                                name: '护照'
                            }
                        ]
                    },
                    {
                        id: "isVip",
                        label: '是否是vip',
                        type: 'select',
                        valueField: 'id',
                        textField: "name",
                        rules: 'required',
                        subdata: [{
                                id: 0,
                                name: '是'
                            },
                            {
                                id: 1,
                                name: '否'
                            }
                        ]
                    },
                    {
                        id: "regName",
                        label: '姓名',
                        type: 'text',
                        rules: 'required',
                    },
                    {
                        id: "age",
                        label: '年龄',
                        type: 'number',
                        rules: 'required',
                        isShowCalculator: false,
                    },
                    {
                        id: "birthday",
                        label: '出生日期',
                        type: 'date',
                        rules: 'required',
                    },
                    {
                        id: "sex",
                        label: '性别',
                        type: 'radio',
                        subdata: [{
                                id: '1',
                                name: '男'
                            },
                            {
                                id: '2',
                                name: '女'
                            }
                        ],
                        value: '1',
                        valueField: "id",
                        textField: 'name',
                        rules: 'required',
                    },
                    {
                        id: 'phoneNo',
                        type: 'text',
                        label: '手机号'
                    },
                    {
                        id: 'grade',
                        type: 'text',
                        label: '文化程度',
                        dictArguments: "grade",
                        type: 'select',
                        textField: '',
                        valueField: ''
                    },
                    {
                        id: 'nativePlace',
                        type: 'text',
                        label: '籍贯',

                    },
                    {
                        id: 'address',
                        type: 'text',
                        label: '家庭住址'
                    },
                    {
                        id: 'nation',
                        type: 'text',
                        label: '民族',
                        dictArguments: "nation",
                        type: 'select',
                        textField: 'value',
                        valueField: 'id',

                    },
                    {
                        id: 'marriage',
                        label: '婚姻状态',
                        dictArguments: "marriage",
                        type: 'select',
                        textField: 'value',
                        valueField: 'value',
                        subdata: [{
                                id: '1',
                                value: '已婚'
                            },
                            {
                                id: '2',
                                value: '未婚'
                            },
                            {
                                id: '3',
                                value: '不祥'
                            }
                        ]
                    },
                    {
                        id: 'customerName',
                        type: 'select',
                        label: '工作单位',
                        url: getRootPath() + '/customer/getPageListOfAll',
                        contentType: '',
                        mentod: 'POST',
                        dataSrc: 'rows',
                        valueField: 'customerId',
                        textField: 'customerName',
                    },
                    {
                        id: 'customerDeptName',
                        type: 'text',
                        label: '车间部门',
                    },
                    {
                        id: 'empNo',
                        type: 'text',
                        label: '工号',

                    },
                    {
                        id: 'workTypeName',
                        type: 'select',
                        label: '工种',
                        url: getRootPath() + '/pfdCustomerWorks/getList',
                        contentType: '',
                        mentod: 'POST',
                        dataSrc: 'rows',
                        valueField: 'id',
                        textField: 'workName',

                    },
                    {
                        id: 'customerBatchId',
                        type: 'text',
                        label: '合同批次'
                    },
                    {
                        id: 'whenEntry',
                        type: 'date',
                        label: '入场日期'
                    },
                    {
                        id: 'workYears', //number
                        type: 'number',
                        label: '总工龄',
                        isShowCalculator: false,
                    },
                    {
                        id: 'hazardYears',
                        type: 'number',
                        label: '接害工龄',
                        isShowCalculator: false,
                    },
                    {
                        id: 'id',
                        type: 'hidden'
                    }
                ]
            },
            /* 优惠券 */
            pricingBlockList: {
                id: regId.pricingBlockListId,
                type: 'blockList',
                data: {
                    idField: "id",
                    dataSource: [{

                    }]
                },
                columns: [{
                        field: 'pricingCode',
                        title: '编号'
                    },
                    {
                        field: 'standardAmount',
                        title: '标准价格',
                        columnType: "money",
                        editConfig: {
                            type: "number",
                        },
                        formatHandler: {
                            type: 'money',
                            data: {
                                format: {
                                    places: "2"
                                }
                            }
                        }
                    },
                    {
                        field: 'discountAmount',
                        title: '优惠券'
                    },
                    {
                        field: 'amount',
                        title: '实收金额',
                        columnType: "money",
                        editConfig: {
                            type: "number",
                        },
                        formatHandler: {
                            type: 'money',
                            data: {
                                format: {
                                    places: "2"
                                }
                            }
                        }
                    }
                ],
                ui: {
                    listExpression: "<div>{{pricingCode}}</div><div><span>标准价格：{{standardAmount}}</span></div><div><span>标准价格：{{standardAmount}}</span></div>",
                    height: 200,
                    isOpenQuery: true,
                }
            },
            /* 职业危害因素 */
            hazardBlockList: {
                id: regId.hazardBlockListId,
                type: "blockList",
                data: {
                    idField: "id",
                    dataSource: [{
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        },
                        {
                            hazardName: "噪音",
                            ocpcName: "在岗期间"
                        }
                    ]
                },
                columns: [{
                        field: 'hazardName',
                        title: '职业危害'
                    },
                    {
                        field: 'ocpcName',
                        title: '监护种类名称'
                    }
                ],
                ui: {
                    height: 200,
                    listExpression: '<div>{{hazardName}}</div>'
                }
            },
            /* 项目 */
            regcomboBlocklist: {
                id: regId.regcomboBlocklistId,
                type: "blockList",
                data: {
                    idField: "id",
                    dataSource: [{
                            comboName: "噪音",
                            standardAmount: "500"
                        },
                        {
                            comboName: "噪音",
                            standardAmount: ""
                        },
                        {
                            comboName: "噪音",
                            standardAmount: "在岗期间"
                        },
                        {
                            comboName: "噪音",
                            standardAmount: "在岗期间"
                        },
                        {
                            comboName: "噪音",
                            standardAmount: "在岗期间"
                        },
                        {
                            comboName: "噪音",
                            standardAmount: "在岗期间"
                        },
                        {
                            comboName: "噪音",
                            standardAmount: "在岗期间"
                        }
                    ]
                },
                columns: [{
                        field: 'comboName',
                        title: '噪音'
                    },
                    {
                        field: 'standardAmount',
                        title: '标准金额',
                        columnType: "money",
                        editConfig: {
                            type: "number",
                        },
                        formatHandler: {
                            type: 'money',
                            data: {
                                format: {
                                    places: "2"
                                }
                            }
                        }
                    }
                ],
                ui: {
                    height: 200,
                    listExpression: '<div>{{comboName}}<span> {{standardAmount}}</span></div>'
                }
            },
        };

        //添加项目弹框
        var addCombo = function () {
            var addComboDialog = {
                id: regId.addComboDialogId,
                templateName: 'PC',
                height: '80%',
                width: '80%',
                title: '添加项目',
                shownHandler: function (data) {
                    var selectedData = ''; //存放选中行数据
                    var dialogBodyId = data.config.bodyId;
                    var footerBodyId = data.config.footerId;
                    $('#' + dialogBodyId).html(
                        '<div class="pt-tab-header">\
                        <div class="pt-nav">\
                            <ul class="pt-tab-list-components-tabs">\
                                <li id="tab-propertyList" class="component-list pt-nav-item current" ns-name="unitList">\
                                    <a id="tab-color" href="javascript:void(0);">单位套餐 </a>\
                                </li>\
                                <li id="tab-processorList" class="component-list pt-nav-item" ns-name="regList">\
                                    <a id="tab-color-2" href="javascript:void(0);" hidden> 体检套餐 </a>\
                                </li>\
                                <li id="tab-processorList" class="component-list pt-nav-item" ns-name="itemList">\
                                    <a id="tab-color-2" href="javascript:void(0);" hidden> 体检项目</a>\
                                </li>\
                            </ul>\
                        </div>\
                    </div>\
                    <div id="netstar-saas-addcombo"></div>'
                    );
                    $('#' + footerBodyId).html(
                        '<div id="netstar-saas-addcombo-btns"></div>');
                    //项目
                    var formData = NetstarComponent.getValues(regId.voId);
                    var regListAjaxData = formData.customerName;
                    var itemList = {
                        id: 'netstar-saas-addcombo',
                        data: {
                            idField: 'id',
                            src: getRootPath() + '/npebase/datCombos/getList',
                            contentType: 'application/json',
                            mentod: 'GET',
                            dataSrc: 'rows',
                            data: {},
                        },
                        columns: [{
                                field: 'itemClassId',
                                title: '项目类别',
                            },
                            {
                                field: 'comboName',
                                title: '组合项目',
                            },
                            { //number
                                field: 'comboPrice',
                                title: '标准金额',

                            }
                        ],
                        ui: {
                            isCheckSelect: true,
                            isOpenQuery: true,
                            height: 500
                        }
                    };
                    var regList = {
                        id: 'netstar-saas-addcombo',
                        data: {
                            idField: 'id',
                            src: getRootPath() + '/npebase/datPackages/getListWithoutCustomer',
                            contentType: 'application/json',
                            mentod: 'GET',
                            data: {

                            },
                        },
                        columns: [{
                                field: 'dictClassName',
                                title: '体检项目',
                            },
                            {
                                field: 'packageName',
                                title: '套餐名称',
                            },
                            {
                                field: 'basePrice', //number
                                title: '标准金额',
                            },
                            {
                                field: 'itemType',
                                title: '优惠金额',
                            },
                            {
                                field: 'price',
                                title: '应收金额',
                            },
                            {
                                field: 'discount',
                                title: '折扣率',
                            }
                        ],
                        ui: {
                            isOpenQuery: true,
                            selectedHandler: function (data) {
                                debugger;
                                var id = data.id
                                var ajaxConfig = {
                                    url: getRootPath() + '/npebase/datPackageCombos/getList',
                                    contentType: 'application/json',
                                    type: 'GET',
                                    data: {
                                        packageId: id
                                    },
                                }
                                NetStarUtils.ajax(ajaxConfig, function (res) {
                                    selectedData = res.rows
                                    console.log(selectedData)
                                })
                            }
                        }
                    };
                    var unitList = {
                        id: 'netstar-saas-addcombo',
                        data: {
                            idField: 'id',
                            src: getRootPath() + '/npebase/datPackages/getList',
                            contentType: 'application/json',
                            mentod: 'GET',
                            data: {
                                customerId: regListAjaxData
                            },
                        },
                        columns: [{
                                field: 'dictClassName',
                                title: '体检项目',
                            },
                            {
                                field: 'packageName',
                                title: '套餐名称',
                            },
                            {
                                field: 'basePrice', //number
                                title: '标准金额',
                            },
                            {
                                field: 'itemType',
                                title: '优惠金额',
                            },
                            {
                                field: 'price',
                                title: '应收金额',
                            },
                            {
                                field: 'discount',
                                title: '折扣率',
                            }
                        ],
                        ui: {
                            isOpenQuery: true,
                            height: 500,
                            selectedHandler: function (data) {
                                setSelectedData(data)

                            }
                        }
                    }
                    NetStarGrid.init(unitList);
                    var dialogDataManage = {
                        currentName: 'unitList',
                        data: {},
                        table: {
                            itemList: itemList,
                            regList: regList,
                            unitList: unitList,
                        }
                    };
                    //选中行调取方法返回转换数据
                    var setSelectedData = function (selected) {
                        debugger;
                        var id = data.id
                        var ajaxConfig = {
                            url: getRootPath() + '/npebase/datPackageCombos/getList',
                            contentType: 'application/json',
                            type: 'GET',
                            data: {
                                packageId: id
                            },
                        }
                        NetStarUtils.ajax(ajaxConfig, function (res) {
                            if (res.success) {

                            }
                        })
                    }
                    // NetStarGrid.init(unitList);
                    // NetStarGrid.init(regList);
                    // 添加tab事件
                    var $lis = $('#' + dialogBodyId).find('li');
                    $lis.off('click');
                    $lis.on('click', function (ev) {
                        var $this = $(this);
                        // 记录数据
                        dialogDataManage.data[dialogDataManage.currentName] = NetStarGrid
                            .getCheckedData('netstar-saas-addcombo');
                        // 切换tab
                        $lis.removeClass('current');
                        $this.addClass('current');
                        dialogDataManage.currentName = $this.attr('ns-name');
                        // 切换table
                        var gridConfig = dialogDataManage.table[dialogDataManage.currentName];
                        // 设置默认值
                        NetStarGrid.init(gridConfig);
                    });
                    var addComboBtns = {
                        id: 'netstar-saas-addcombo-btns',
                        btns: [{
                                text: '确认',
                                handler: function () {
                                    //传参 comboIds
                                    var checkedData = NetStarGrid.getCheckedData(
                                        'netstar-saas-addcombo');
                                    var itemIds = '';
                                    var unitList = ''
                                    for (var i = 0; i < checkedData.length; i++) {
                                        itemIds += checkedData[i].id + ','
                                    }
                                    for (var j = 0; j < selectedData.length; j++) {
                                        unitList += selectedData[j].id + ','
                                    }
                                    var comboIds = '';
                                    if (itemIds != '' && unitList == '') {
                                        comboIds = itemIds
                                    } else if (unitList != '' && itemIds == '') {
                                        comboIds = unitList
                                    } else {
                                        comboIds = itemIds + unitList;
                                    }

                                    var ajaxConfig = {
                                        url: getRootPath() + 'reg/combos/addCombo',
                                        contentType: 'application/x-www-form-urlencoded',
                                        type: 'POST',
                                        data: {
                                            comboIds: comboIds
                                        }
                                    }
                                    NetStarUtils.ajax(ajaxConfig, function (res) {
                                        if (res.success) {
                                            //获取项目数据
                                            NetstarComponent.dialog[regId
                                                .addComboDialogId].vueConfig.close();
                                            for (var i = 0; i < res.rows.length; i++) {
                                                res.rows[i].isOwnExpense = 1;
                                                res.rows[0].packageId = "4444"
                                            }
                                            saasReg.addComboVOList = res.rows;
                                            //存放数据
                                            pagesData.addComboVOListData = res.rows;
                                            saasReg.itemShowOrHidden();
                                            saasReg.itemAmount();
                                        }
                                    })
                                }
                            },
                            {
                                text: '关闭',
                                handler: function () {
                                    NetstarComponent.dialog[regId.addComboDialogId].vueConfig
                                        .close()
                                }
                            }
                        ]
                    }

                    vueButtonComponent.init(addComboBtns);
                }

            };
            NetstarComponent.dialogComponent.init(addComboDialog)
        }

        function init() {
            NetstarComponent.formComponent.show(configs.regVo);
            // NetstarBlockList.init(configs.pricingBlockList);
            // NetstarBlockList.init(configs.hazardBlockList);
            // NetstarBlockList.init(configs.regcomboBlocklist);
            vueButtonComponent.init(configs.regBtns);
            vueButtonComponent.init(configs.regHazardbtns);
            height: 500

            /* vueButtonComponent.init(configs.regcombobtns) */
        }
        init();
    </script>
</container>
</body>

</html>