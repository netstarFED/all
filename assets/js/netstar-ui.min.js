nsUI.stateTable=function(r,e){var t=$("table#"+r+" tr").eq(0);var a=t.children("td").length;var n=100/a+"%";t.children("td").attr("style","width:"+n);var f={placement:"top",container:"body",trigger:"hover"};$("table#"+r+" tr td[data-content]").popover(f);if(typeof e!="object"){return false}var i=[];$.each(e,function(r,e){var t={};t[r]=e;i.push(t)});var v=i.sort(function(r,e){var t,a;for(var n in r){t=r[n]}for(var n in e){a=e[n]}if(t<a)return-1;if(t>a)return 1;return 0});var o=[];var l=[];var s=0;$.each(v,function(r,e){var t;var a;var n;for(var f in e){a=f;t=e[f];if(f=="none"){s=n}n++}l.push(a);o.push(t)});var d=$("table#"+r+" tr td");for(var h=0;h<d.length;h++){if($(d[h]).text()!=""){var u=Number($(d[h]).text());var c=s;for(var p=0;p<o.length;p++){if(p==o.length-1){if(o[p][0]!=o[p][1]){if(u>=o[p][0]&&u<=o[p][1]){c=p}}else{if(u==o[p][0]){c=p}}}else{if(o[p][1]==o[p][1]){if(o[p][0]!=o[p][1]){if(u>=o[p][0]&&u<o[p][1]){c=p}}else{if(u==o[p][0]){c=p}}}else{if(o[p][0]!=o[p][1]){if(u>=o[p][0]&&u<=o[p][1]){c=p}}else{if(u==o[p][0]){c=p}}}}}var b="";if(typeof l[c]!="undefined"){b=l[c];$(d[h]).addClass(b)}}}};
nsUI.addSearchInput={};nsUI.addSearchInput.init=function(formJson,config){var $input=$("#form-"+formJson.id+"-"+config.id);var columnNum=0;var columnTitle=[];var columnType=[];var columnData=[];var columnWidth=[];var dataSearch=[];var dataAjax=[];var dataKey=[];var dataTitle=[];var autoWidthColumnNum=0;var autoWidthColumnTotal=0;for(var col=0;col<config.localDataConfig.length;col++){if(config.localDataConfig[col].visible){columnData[config.localDataConfig[col].visible-1]=col;columnNum++}if(config.localDataConfig[col].search!=false){dataSearch.push(col)}if(config.localDataConfig[col].ajax){dataAjax.push(col)}if(config.localDataConfig[col].key){dataKey.push(config.localDataConfig[col].key)}else{dataKey.push(-1)}if(config.localDataConfig[col].title){dataTitle.push(config.localDataConfig[col].title)}else{dataTitle.push("")}}for(var colI=0;colI<columnData.length;colI++){var currentData=config.localDataConfig[columnData[colI]];columnTitle.push(currentData.title);columnType.push(currentData.type);if(typeof currentData.width=="undefined"){autoWidthColumnNum++}else if(typeof currentData.width=="number"){autoWidthColumnTotal+=currentData.width}else{nsalert("宽度参数错误","error")}columnWidth.push(currentData.width)}if(autoWidthColumnNum>0){if(autoWidthColumnTotal<=100){var columnWidthStr=parseInt((100-autoWidthColumnTotal)/autoWidthColumnNum*1e3)/1e3+"%";for(var i=0;i<columnWidth.length;i++){if(typeof columnWidth[i]=="undefined"){columnWidth[i]=columnWidthStr}else{columnWidth[i]=columnWidth[i]+"%"}}}else{nsalert("宽度设置错误，请设置为数字，总和不大于100")}}config.columnData=columnData;config.columnType=columnType;config.columnNum=columnNum;config.columnWidth=columnWidth;config.columnTitle=columnTitle;config.dataSearch=dataSearch;config.dataAjax=dataAjax;config.dataKey=dataKey;config.dataTitle=dataTitle;function clickHiddenPlaneHandler(a){$(document).off("click",clickHiddenPlaneHandler);if($(a.target).closest(".result-plane").length==0){if($(a.target).closest(".add-select-input-btn").length==0){$input.parent().children(".result-plane").remove()}}}function inputFocusHandler(a){$input.off("focus");$input.on("blur",function(a){$input.off("blur");$input.on("focus",inputFocusHandler);$(document).on("click",clickHiddenPlaneHandler)});nsUI.addSearchInput.top10Plane(config,$input);var e={};e.input=$input;e.config=config;$input.on("keyup",e,nsUI.addSearchInput.inputKeyHandler)}$input.on("focus",inputFocusHandler);var $refreshBtn=$input.parent().children('[ns-control="refresh"]');$refreshBtn.on("click",function(ev){$refreshBtn.children("i").addClass("fa-spin");var timestamp=(new Date).getTime();timestamp={timestamp:timestamp};$.ajax({url:config.refreshAjax,data:timestamp,dataType:"json",success:function(data){if(typeof data.data=="string"){data.data=eval(data.data)}if($.isArray(data.data)){config.localDataArr=data.data;if($input.parent().children(".result-plane").length>0){nsUI.addSearchInput.top10Plane(config,$input);$input.focus()}else{console.log("aaaaa");nsUI.addSearchInput.clearValue(config,$input,false)}}else{nsalert("返回的数据不是数组","error")}},error:function(a){nsalert("数据返回错误","error");console.log(a)},complete:function(){$refreshBtn.children("i").removeClass("fa-spin")}})});var $listBtn=$input.parent().children('[ns-control="list"]');if(typeof config.listHandler=="undefined"){$listBtn.remove()}else{$listBtn.on("click",function(a){var e={};var n=$("#"+config.fullHiddenID).val();if(n==""){e=-1}else{for(var t=0;t<config.localDataArr.length;t++){if(config.localDataArr[t][1]==n){for(var l=0;l<config.dataKey.length;l++){e[config.dataKey[l]]=config.localDataArr[t][l]}}}}config.listHandler(e)})}};nsUI.addSearchInput.selectRow=function(a,e,n){var t=[];for(var l=0;l<e.columnData.length;l++){t.push(e.localDataArr[a][e.columnData[l]])}t[3]=e.localDataArr[a][e.localDataHiddenIDIndex];t[4]=e.localDataArr[a][0];nsUI.addSearchInput.fillValue(t,e,n);$(document).off("keyup",nsUI.addSearchInput.documentKeyHandler);var r={};for(var i=0;i<e.dataAjax.length;i++){r[e.dataKey[e.dataAjax[i]]]=e.localDataArr[a][e.dataAjax[i]]}if(e.localDataAjaxData){$.each(e.localDataAjaxData,function(n,t){r[n]=e.localDataArr[a][t]})}var c=typeof e.confirmAjaxType=="string"?e.confirmAjaxType:"post";$.ajax({url:e.confirmAjax,data:r,dataType:"json",type:c,success:function(a){if(a.success){nsalert("验证成功")}else{nsalert("验证失败，错误原因："+a.msg,"error")}},error:function(a){nsalert(a,"error")}})};nsUI.addSearchInput.currentKeyValue="";nsUI.addSearchInput.inputKeyHandler=function(a){var e=a.data.input;var n=a.data.config;var t=n.localDataArr;var l=$.trim(e.val());if(l==""){if(nsUI.addSearchInput.currentKeyValue!=l){nsUI.addSearchInput.top10Plane(n,e)}}else{if(nsUI.addSearchInput.currentKeyValue!=l){nsUI.addSearchInput.currentKeyValue=l;var r=[];for(var i=0;i<t.length;i++){var c=false;for(var o=2;o<t[i].length;o++){if(t[i][o].indexOf(l)>-1){c=true;r.push(t[i]);break}}if(i>=9){i=t.length}}nsUI.addSearchInput.getPlane(r,n,e,l)}}};nsUI.addSearchInput.save=function(saveData,config,$input){var valueArr=[];$.each(saveData,function(a,e){valueArr.push(e)});valueArr.push("");valueArr.push(-1);nsUI.addSearchInput.fillValue(valueArr,config,$input);$.ajax({url:config.addAjax,data:saveData,dataType:"json",success:function(data){if(data.success){nsalert("添加成功");var resultArr=[];$.each(saveData,function(a,e){resultArr.push(e)});if(typeof data.data=="string"){data.data=eval(data.data)[0]}else if($.isArray(data.data)){data.data=data.data[0]}else{nsalert("保存格式错误","error")}resultArr.push(data.data[config.localDataHiddenIDIndex]);resultArr.push(0);nsUI.addSearchInput.fillValue(resultArr,config,$input);for(var dataI=0;dataI<config.localDataArr.length;dataI++){config.localDataArr[dataI][0]=config.localDataArr[dataI][0]+1}data.data[0]=0;config.localDataArr.unshift(data.data)}else{nsalert("添加失败，错误原因："+data.msg,"error")}}})};nsUI.addSearchInput.documentKeyHandler=function(a){var e=a.data.input;var n=a.data.config;var t=e.parent().children(".result-plane");var l=t.children(".current");if(a.keyCode=="13"){if(l.length>0){var r=parseInt(l.attr("rowindexid"));nsUI.addSearchInput.selectRow(r,n,e)}else{var i=t.children(".add");if(i.length==1){var c=i.find("a span");var o={};var d=false;for(var u=0;u<c.length;u++){o[n.dataKey[n.columnData[u]]]=$(c[u]).html();if($(c[u]).html()=="未输入"){d=true}}if(d){nsConfirm("您填写的数据不完整，是否确认保存？","warning")}nsUI.addSearchInput.save(o,n,e)}}}else if(a.keyCode=="40"){if(l.next().hasClass("plane-content")){l.removeClass("current");l.next().addClass("current");currentRow=l.next()}}else if(a.keyCode=="38"){if(l.prev().hasClass("plane-content")){l.removeClass("current");l.prev().addClass("current");currentRow=l.prev()}}else if(a.keyCode=="27"){nsUI.addSearchInput.closePlane(n,e)}};nsUI.addSearchInput.top10Plane=function(a,e){if(e.val()==""){nsUI.addSearchInput.currentKeyValue="";var n=[];var t=a.localDataArr.length>=10?10:a.localDataArr.length;for(var l=0;l<t;l++){n.push(a.localDataArr[l])}nsUI.addSearchInput.getPlane(n,a,e)}};nsUI.addSearchInput.getPlane=function(a,e,n,t){var l="";var r=[];function i(a,n){var l="";if(n==0){l="current"}var r=[];for(var i=0;i<e.columnData.length;i++){r.push(a[e.columnData[i]])}var c="";if(typeof t=="undefined"){t=""}for(var o=0;o<r.length;o++){if(t!=""){r[o]=r[o].replace(t,"<b>"+t+"</b>")}c+='<span style="width:'+e.columnWidth[o]+'">'+r[o]+"</span>"}c='<div class="plane-content '+l+'" rowIndexID = "'+a[0]+'">'+'<a href="javascript:void(0);">'+c+"</a>"+"</div>";return c}function c(a){planeTitleHtml="";for(var e=0;e<a.columnTitle.length;e++){planeTitleHtml+='<span style="width:'+a.columnWidth[e]+'">'+a.columnTitle[e]+"</span>"}planeTitleHtml='<div class="plane-title">'+planeTitleHtml+"</div>";return planeTitleHtml}if(a.length>0){planeTitleHtml=c(e);for(var o=0;o<a.length;o++){l+=i(a[o],o)}}else{planeTitleHtml="";l='<div class="empty">没有符合条件的数据。您可以直接新建这条数据，使用空格为分隔符</div>';if(t.indexOf(" ")>-1){var d="";var u=t.split(" ");var s=0;var f=0;var p=[];var h=[];var v=[];for(var m=0;m<e.columnType.length;m++){if(e.columnType[m]=="number"){s++;p.push(m)}else if(e.columnType[m]=="string"){f++;h.push(m)}v.push("")}var g=0;var I=0;var y=[];var D=[];for(var S=0;S<u.length;S++){var A=new RegExp("^[0-9]*$");var T=A.test(u[S]);if(T){I++;y.push(S)}else{g++;D.push(S)}}if(s>0&&I>0){if(s<=I){for(var U=0;U<p.length;U++){v[p[U]]=u[y[U]]}}else if(s>I){for(var U=0;U<p.length;U++){if(typeof u[y[U]]!="undefined"){v[p[U]]=u[y[U]]}else{v[p[U]]=u[y[0]]}}}}var H=0;var x=0;for(var C=0;C<v.length;C++){if(v[C]==""){if(e.columnType[C]=="string"){if(typeof u[D[x]]!="undefined"){v[C]=u[D[x]]}else{if(D.length==0){v[C]=u[u.length-1]}else{v[C]=u[D[g-1]]}}x++}else if(e.columnType[C]=="number"){v[C]=u[y[H]];if(typeof u[y[H]]!="undefined"){v[C]=u[y[H]]}else{if(y.length==0){v[C]="未输入"}else{v[C]=u[y[I-1]]}}H++}}}for(var k=0;k<v.length;k++){d+='<span style="width:'+e.columnWidth[k]+'">'+v[k]+"</span>"}d='<div class="plane-content add'+'" rowIndexID = "">'+'<a href="javascript:void(0);">'+d+"</a>"+"</div>";l=l+d;planeTitleHtml=c(e)}}var j=n.parent().children(".result-plane");if(j.length==0){n.after('<div class="result-plane">'+l+planeTitleHtml+"</div>");var W={};W.input=n;W.config=e;$(document).off("keyup");$(document).on("keyup",W,nsUI.addSearchInput.documentKeyHandler);n.parent().children(".result-plane").children(".plane-content").off("click");n.parent().children(".result-plane").children(".plane-content").on("click",function(a){var t=parseInt($(this).attr("rowindexid"));nsUI.addSearchInput.selectRow(t,e,n)})}else{j.html(l+planeTitleHtml);n.parent().children(".result-plane").children(".plane-content").off("click");n.parent().children(".result-plane").children(".plane-content").on("click",function(a){var t=parseInt($(this).attr("rowindexid"));nsUI.addSearchInput.selectRow(t,e,n)})}};nsUI.addSearchInput.closePlane=function(a,e){e.parent().children(".result-plane").remove();$(document).off("keyup",nsUI.addSearchInput.documentKeyHandler);e.on("focus",function(n){e.off("focus");nsUI.addSearchInput.top10Plane(a,e);var t={};t.input=e;t.config=a;e.on("keyup",t,nsUI.addSearchInput.inputKeyHandler)})};nsUI.addSearchInput.fillValue=function(a,e,n){var t=a[0]+" "+a[1]+" "+a[2];n.val(t);$("#"+e.fullHiddenID).val(a[3]);var l="";if(typeof e.listHandler=="undefined"){l='style = "right:28px;"'}else{l='style = "right:56px;"'}var r='<div class="value-tag"'+l+">"+a[0]+' <span class="remark">（'+a[1]+": "+a[2]+"）</span>"+'<div class="handler-btn">X</div></div>';n.parent().append(r);n.parent().find(".value-tag .handler-btn").on("click",function(a){$(this).off("click");nsUI.addSearchInput.clearValue(e,n)});nsUI.addSearchInput.closePlane(e,n)};nsUI.addSearchInput.clearValue=function(a,e,n){e.val("");$("#"+a.fullHiddenID).val("");e.parent().children(".value-tag").remove();if(n){}else{e.focus();nsUI.addSearchInput.top10Plane(a,e)}};
nsUI.projectSelect=function(e){var a;var s;var r;var t;var l;var i;var n;var d;var c;var f;var o;function v(v){if(a){e("#"+a.id).show();return false}a=v;if(a.$btn){s=a.$btn}$container=a.$container;var u;if(a.id){}else{if(a.$btn){a.id=s.closest(".page-title.nav-form").attr("id")+"-fid"+s.attr("fid")}else{a.id="nsUI-projectSelect-"+Math.round(Math.random()*1e9+1)}}if(typeof a.dataArr=="undefined"){a.dataArr=[]}if(typeof a.listArr=="undefined"){a.listArr=[]}if(typeof a.resultArr=="undefined"){a.resultArr=[]}a.selectedListArr=[];a.selectedResultArr=[];a.childrenID={};a.childrenID.dropdown=a.id+"-menu";a.childrenID.list=a.id+"-list";a.selectClassID="-1";if(typeof nsUI.projectSelect.data!="object"){nsUI.projectSelect.data={}}nsUI.projectSelect.data[a.id]=a;if(typeof $container!="object"){e("body").append(D())}else{if(typeof a.containerMode=="string"){if(a.containerMode=="inner"){$container.addClass("project-select-container")}}$container.html(D())}r=e("#"+a.id+" .ps-title .ps-input input");l=e("#"+a.id+" .ps-body .ps-list");i=e("#"+a.id+" .ps-body .ps-select");t=e("#"+a.id+" .ps-title .ps-input button");n=e("#"+a.id+" .arr .arr-add");d=e("#"+a.id+" .arr .arr-remove");c=e("#"+a.id+" .ps-btn .btn-success");f=e("#"+a.id+" .ps-btn .btn-white");o=e("#"+a.id+" .ps-title .ps-close-btn");e(document).on("keyup",w);r.on("focus",function(a){r.on("blur",function(a){r.off("keyup",g);e(document).off("keyup",w);e(document).on("keyup",w);C()});r.on("keyup",g);e(document).off("keyup",w);j()});r.focus();t.on("click",function(e){k()});n.on("click",$);d.on("click",O);c.on("click",h);f.on("click",p);o.on("click",p)}function u(){if(a){r.off("keyup");n.off("click");d.off("click");c.off("click");f.off("click");o.off("click");e("#"+a.id).remove();a=undefined}}function p(s){e("#"+a.id).hide()}function h(e){A()}function A(){var s=a.confirmHandler;if(typeof s=="function"){var r="";var t=[];for(var l=0;l<a.resultArr.length;l++){t.push(a.resultArr[l][a.listAjax.valueField]);r+='"'+a.resultArr[l][a.listAjax.valueField]+'"';if(l<a.resultArr.length-1){r+=","}}r="["+r+"]";a.selected=r;var i={};i.string=r;i.array=a.resultArr;i.value=t;s(i);e("#"+a.id).hide()}}function g(a){switch(a.keyCode){case 32:var s=l.children("ul").children('li[ns-psid][class="ready"]');if(s.length>0){var t=s.attr("ns-psid");W(t,s);K();j();var i=r.val();i=e.trim(i);r.val(i);r.select()}break;case 40:y();break;case 38:m();break;case 37:x();j();break;case 39:b();j();break;case 13:A();break;case 27:p();break;default:k();j();break}}function y(){var e=l.children("ul").children('li[ns-psid][class="ready"]');if(e.length==0){return false}var s;function r(e){var t=e.next("[ns-psid]");if(t.length==0){s=false;if(a.listPageIndex[1]<a.listArr.length-1){b();j()}else{nsalert("已经是最后一行","warning");return false}}else{if(t.attr("class")==""){s=t}else{r(t)}}}r(e);if(s){e.removeClass("ready");s.addClass("ready")}}function m(){var e=l.children("ul").children('li[ns-psid][class="ready"]');if(e.length==0){return false}var s;function r(e){var t=e.prev("[ns-psid]");if(t.length==0){s=false;if(a.listPageIndex[0]>0){x();I()}else{nsalert("已经是第一行","warning");return false}}else{if(t.attr("class")==""){s=t}else{r(t)}}}r(e);if(s){e.removeClass("ready");s.addClass("ready")}}function b(){if(a.listPageIndex[1]>=a.listArr.length-1){nsalert("已经是最后一页","warning")}else{K([a.listPageIndex[0]+10,a.listPageIndex[1]+10])}}function x(){if(a.listPageIndex[0]==0){nsalert("已经是第一页","warning")}else{K([a.listPageIndex[0]-10,a.listPageIndex[1]-10])}}function j(){l.children("ul").children('li[ns-psid][class="ready"]').removeClass("ready");l.children("ul").children('li[ns-psid][class=""]').eq(0).addClass("ready")}function I(){l.children("ul").children('li[ns-psid][class="ready"]').removeClass("ready");l.children("ul").children('li[ns-psid][class=""]').last().addClass("ready")}function C(){l.children("ul").children('li[ns-psid][class="ready"]').removeClass("ready")}function k(){var e=r.val();var s=true;if(a.selectClassID=="-1"){s=true}else{s=false}a.listArr=[];if(e==""){if(s){a.listArr=[].concat(a.dataArr)}else{for(var t=0;t<a.dataArr.length;t++){if(a.dataArr[t][a.listAjax.classField]==a.selectClassID){a.listArr.push(a.dataArr[t])}}}}else{a.listArr=[];var l=false;if(a.listAjax.pyField){l=true}var i=false;if(a.listAjax.wbField){i=true}for(var n=0;n<a.dataArr.length;n++){if(!s&&a.dataArr[n][a.listAjax.classField]!=a.selectClassID){}else{var d=false;if(a.dataArr[n][a.listAjax.textField].indexOf(e)>-1){d=true}if(!d&&l){if(a.dataArr[n][a.listAjax.pyField].toLocaleUpperCase().indexOf(e.toLocaleUpperCase())>-1){d=true}}if(!d&&i){if(a.dataArr[n][a.listAjax.wbField].toLocaleUpperCase().indexOf(e.toLocaleUpperCase())>-1){d=true}}if(d){a.listArr.push(a.dataArr[n])}}}}K([0,9])}function w(e){switch(e.keyCode){case 37:x();break;case 39:b();break;case 38:var a=l.children("ul").children('li[ns-psid][class="ready"]');if(a.length==0){I()}else{m()}break;case 40:var a=l.children("ul").children('li[ns-psid][class="ready"]');if(a.length==0){j()}else{y()}break;case 13:A();break;case 27:p();break;case 32:var a=l.children("ul").children('li[ns-psid][class="ready"]');if(a.length>0){var s=a.attr("ns-psid");W(s,a);K();j()}}}function D(){var s=e(window).height();var r=470;var t="";var l="";var i=S();var n=P();l='<div class="project-select-plane" id="'+a.id+'" style="'+t+'">'+i+'<div class="ps-body">'+'<div class="ps-list">'+n+"</div>"+'<div class="arr">'+'<a class="arr-add none" href="javascript:void(0);"><i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>'+'<a class="arr-remove none" href="javascript:void(0);"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></a>'+"</div>"+'<div class="ps-select">'+"</div>"+"</div>"+'<div class="ps-footer">'+'<div class="ps-help">'+'<span><i class="fa fa-keyboard-o" ></i> 左右翻页，上下移动，空格选择，回车确认</span><br>'+'<span><i class="fa fa-hand-o-up" ></i> 单击选择，双击操作，箭头批量操作</span>'+"</div>"+'<div class="ps-btn">'+'<button class="btn btn-success"><i class="fa fa-check"></i> 确认</button>'+'<button class="btn btn-white">取消</button>'+"</div>"+"</div>"+"</div>";return l}function S(){var e="";if(typeof a.classVisible!="boolean"){a.classVisible=true}var s="";if(a.classVisible){var r=F();if(typeof a.classWidth=="number"){e='style="width:'+a.classWidth+'px; "'}else if(typeof a.classWidth=="string"){e='style="width:'+a.classWidth+'; "'}s='<div class="ps-select" '+e+">"+'<button class="btn btn-default dropdown-toggle" type="button" id="'+a.childrenID.dropdown+'" data-toggle="dropdown">'+'<span class="name">全部分类 </span>'+'<span class="caret"></span>'+"</button>"+'<ul class="dropdown-menu" role="menu" aria-labelledby="'+a.childrenID.dropdown+'">'+r+"</ul>"+"</div>"}else{}var t="选择项目";if(a.title){t=a.title}var l="名称 / 简拼";if(typeof a.searchPlaceHolder=="string"){l=a.searchPlaceHolder}var i='<div class="ps-title">'+'<lable class="ps-label">'+t+"： </lable>"+s+'<div class="ps-input">'+'<input type="text" id="aaa" name="aaa" placeholder="">'+'<button><i class="fa fa-search" aria-hidden="true"></i></button>'+"</div>"+'<a class="ps-close-btn" href="javascript:void(0);">x</a>'+"</div>";return i}function F(){var s="";if(e.isArray(a.classArr)){for(var r=0;r<a.classArr.length;r++){var t=a.classArr[r][a.classAjax.textField];var l=a.classArr[r][a.classAjax.valueField];var i="javascript:nsUI.projectSelect.selectClass('"+a.id+"','"+l+"','"+t+"');";s+='<li role="presentation" classID="'+l+'">'+'<a role="menuitem" tabindex="-1" href="'+i+'">'+t+"</a>"+"</li>"}var n="javascript:nsUI.projectSelect.selectClass('"+a.id+"','-1','全部分类');";s+='<li role="presentation" class="divider"></li>'+'<li role="presentation">'+'<a role="menuitem" tabindex="-1" href="'+n+'">全部分类</a>'+"</li>"}else{s='<li role="presentation" classID="-1">'+'<a role="menuitem" tabindex="-1" href="javascript:void(0);">'+'<i class="fa fa-refresh fa-spin fa-3x fa-fw"></i> 正在加载...'+"</a>"+"</li>";L()}return s}function L(){var s=a.classAjax.url?a.classAjax.data:"";var r=a.classAjax.type?a.classAjax.type:"post";var t=a.classAjax.dataSrc?a.classAjax.dataSrc:"rows";e.ajax({url:a.classAjax.url,data:s,type:r,success:function(s){var r;if(e.isArray(s[t])){a.classArr=s[t];r=F()}else{r='<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);"><i class="fa fa-exclamation-circle"></i> 无分类信息</a></li>'}e('[aria-labelledby="'+a.childrenID.dropdown+'"]').html(r)}})}function R(s,r,t){e("#"+s+" .ps-title .ps-select button .name").html(t+" ");a.selectClassID=r;k()}function P(e){var s="";if(a.dataArr.length>0){var r=0;var t=5;if(e){r=e[0];t=e[1]}var l="";if(t>=a.listArr.length-1){for(var i=a.listArr.length;i<=t;i++){l+='<li><a href="javascript:void(0);">'+'<div class="index">'+(i+1)+"</div>"+'<div class="name"></div>'+"</a></li>"}t=a.listArr.length-1}for(var n=r;n<=t;n++){var d=a.listArr[n][a.listAjax.textField];var c=a.listArr[n][a.listAjax.valueField];var f=a.listArr[n].isInResult?"null ":"";var o=a.listArr[n].isInSelect?"select":"";var v='<li ns-psid="'+c+'" class="'+f+o+'"><a href="javascript:void(0);">'+'<div class="index">'+(n+1)+"</div>"+'<div class="name">'+d+"</div>"+"</a></li>";s+=v}s="<ul>"+s+l+"</ul>";var u=a.listArr.length;var p=Math.ceil(a.listArr.length/10);var h=Math.ceil((r+1)/10);var A="";var g="";var y="";var m="";if(h==1){A="javascript:void(0);";g='class="not"'}else{A="javascript:nsUI.projectSelect.toPage("+(h-1)+");"}if(h==p){y="javascript:void(0);";m='class="not"'}else{y="javascript:nsUI.projectSelect.toPage("+(h+1)+");"}if(a.listArr.length>0){s+='<div class="state">'+'<div class="page">'+'<a href="'+A+'" '+g+">"+'<i class="fa fa-angle-left" aria-hidden="true"></i>'+"</a>"+"</div>"+'<div class="page">'+h+" / "+p+"</div>"+'<div class="page">'+'<a href="'+y+'" '+m+">"+'<i class="fa fa-angle-right" aria-hidden="true"></i>'+"</a>"+"</div>"+"<span> 共："+u+"</span>"+"</div>"}else{s+='<div class="state">'+"搜索结果为空"+"</div>"}}else{s='<div class="loading">'+'<i class="fa fa-refresh fa-spin"></i>'+"<p>正在加载...</p>"+"</div>";B()}return s}function U(e){var a=(e-1)*10;var s=e*10-1;var r=[a,s];K(r)}function M(e){if(a.listArr){a.listArr=[]}if(a.dataArr){a.dataArr=[]}var s='<div class="loading">'+'<i class="fa fa-exclamation-triangle"></i>'+"<p>"+e+"</p>";"</div>";l.html(s)}function K(s){if(s){a.listPageIndex=s}else{s=a.listPageIndex}listHtml=P(s);l.html(listHtml);l.children("ul").children("li[ns-psid]").on("click",function(a){var s=e(this).attr("ns-psid");if(e(this).hasClass("null")){nsalert("已选中，不能多次选择","warning")}else{var r=e(this).attr("timestamp");if(typeof r=="string"){var t=(new Date).getTime();var l=parseInt(e(this).attr("timestamp"));if(t-l<500){W(s,this)}else{if(e(this).hasClass("select")){H(s,this)}else{T(s,this)}}}else{T(s,this)}}})}function $(s){if(e(this).hasClass("none")){nsalert("请先选择项目","warning")}else{var r={};for(var t=0;t<a.selectedListArr.length;t++){var l=a.selectedListArr[t][a.listAjax.valueField];var i=e("#"+a.id+' [ns-psid="'+l+'"]');r[l]={};r[l].id=a.selectedListArr[t][a.listAjax.valueField];r[l].liDOM=e("#"+a.id+' [ns-psid="'+l+'"]')}e.each(r,function(e,a){W(a.id,a.liDOM)});delete r}}function O(s){if(e(this).hasClass("none")){nsalert("请先选择项目","warning")}else{var r={};for(var t=0;t<a.selectedResultArr.length;t++){var l=a.selectedResultArr[t][a.listAjax.valueField];var i=e("#"+a.id+' [ns-psid="'+l+'"]');r[l]={};r[l].id=a.selectedResultArr[t][a.listAjax.valueField];r[l].liDOM=e("#"+a.id+' [ns-psid="'+l+'"]')}e.each(r,function(e,a){z(a.id,a.liDOM)});delete r}}function T(s,r){var t=a.dataArr[a.dataKey[s]];t.isInSelect=true;l.find(".ready").removeClass("ready");e(r).addClass("select");e(r).attr("timestamp",(new Date).getTime());a.selectedListArr.push(t);n.removeClass("none")}function H(s,r){var t=a.dataArr[a.dataKey[s]];t.isInSelect=false;e(r).removeClass("select");e(r).attr("timestamp",(new Date).getTime());var l;for(var i=0;i<a.selectedListArr.length;i++){if(a.selectedListArr[i]==t){l=i}}a.selectedListArr.splice(l,1);if(a.selectedListArr.length==0){n.addClass("none")}}function W(s,r){var t;t=a.dataArr[a.dataKey[s]];a.resultArr.push(t);var l;for(var i=0;i<a.selectedListArr.length;i++){if(a.selectedListArr[i]==t){l=i}}a.selectedListArr.splice(l,1);t.isInResult=true;t.isInSelect=false;if(a.selectedListArr.length==0){n.addClass("none")}V();if(r){e(r).attr("class","null")}}function V(){var s="";for(var r=0;r<a.resultArr.length;r++){var t=a.resultArr[r][a.listAjax.textField];var l=a.resultArr[r][a.listAjax.valueField];var n=a.resultArr[r].isInSelect?"select":"";var d='<li ns-psid="'+l+'" class="'+n+'"><a href="javascript:void(0);">'+'<div class="index">'+(r+1)+"</div>"+'<div class="name">'+t+"</div>"+"</a></li>";s+=d}s="<ul>"+s+"</ul>";i.html(s);i.children("ul").children("li[ns-psid]").on("click",function(a){var s=e(this).attr("ns-psid");var r=e(this).attr("timestamp");if(typeof r=="string"){var t=(new Date).getTime();var l=parseInt(e(this).attr("timestamp"));if(t-l<500){z(s,this)}else{if(e(this).hasClass("select")){Q(s,this)}else{q(s,this)}}}else{q(s,this)}})}function q(s,r){var t=a.dataArr[a.dataKey[s]];t.isInSelect=true;e(r).addClass("select");e(r).attr("timestamp",(new Date).getTime());a.selectedResultArr.push(t);d.removeClass("none")}function Q(s,r){var t=a.dataArr[a.dataKey[s]];t.isInSelect=false;e(r).removeClass("select");e(r).attr("timestamp",(new Date).getTime());var l;for(var i=0;i<a.selectedResultArr.length;i++){if(a.selectedResultArr[i]==t){l=i}}a.selectedResultArr.splice(l,1);if(a.selectedResultArr.length==0){d.addClass("none")}}function z(e,s){var r;r=a.dataArr[a.dataKey[e]];var t;for(var l=0;l<a.resultArr.length;l++){if(a.resultArr[l]==r){t=l}}a.resultArr.splice(t,1);var i;for(var n=0;n<a.selectedResultArr.length;n++){if(a.selectedResultArr[n]==r){i=n}}a.selectedResultArr.splice(i,1);r.isInResult=false;r.isInSelect=false;if(a.selectedResultArr.length==0){d.addClass("none")}V();K()}function B(){var s=a.listAjax.url?a.listAjax.data:"";var r=a.listAjax.type?a.listAjax.type:"post";var t=a.listAjax.dataSrc?a.listAjax.dataSrc:"rows";e.ajax({url:a.listAjax.url,data:s,type:r,success:function(s){var r;if(e.isArray(s[t])){if(s[t].length>0){a.dataArr=s[t];a.dataKey={};for(var l=0;l<a.dataArr.length;l++){a.dataKey[a.dataArr[l][a.listAjax.valueField]]=l}if(a.selected&&a.selected!=""&&a.selected!="[]"){var i=a.selected;i=i.substring(1,i.length-1);var n=i.split(",");a.resultArr=[];for(var d=0;d<n.length;d++){var c=n[d];c=c.replace(/'/g,"");c=c.replace(/"/g,"");var f=a.dataArr[a.dataKey[c]];if(typeof f=="object"){f.isInResult=true;a.resultArr.push(f)}else{nsalert("id："+c+" 无法找到对应数据","error")}}V()}a.listArr=[].concat(s[t]);K([0,9]);j()}else{M("没有获取到项目信息，返回项目数量为 0")}}else{M("参数错误：（listAjax.dataSrc："+t+"）")}},error:function(e){M("listAjax请求失败："+e+"）")}})}function E(){var e=a.resultArr;if(a.resultArr.length==0){e=false}return e}function G(){var e=[];var s=false;for(var r=0;r<a.resultArr.length;r++){e.push(a.resultArr[r][a.listAjax.valueField])}console.log(e);if(e.length==0){s=false}else{e=e.sort();s=e.join(",")}return s}return{init:v,selectClass:R,toPage:U,clear:u,getData:E,getDataIDs:G}}(jQuery);
nsUI.personSelect=function(e){var n;var a;var r;var s;var t;var i;var l;var o;var f;var u;var p;var c;var d;var v;var h;var g=[];var x=[];var m=[];var y=[];var A=[];var b=[];var k=[];var j=[];var I="";var C;var w;var D;var O=false;function R(n){ye();if(typeof n=="object"){D=n;D.resultPersonArr=k;if(e.isArray(D.personAjax.personArr)){g=D.personAjax.personArr;x=g}else{g=false;x=false}if(e.isArray(D.personAjax.groupArr)){groupArr=D.personAjax.groupArr;groupListArr=groupArr}else{groupArr=false;groupListArr=false}if(e.isArray(D.historyArr)){A=D.history}else{A=false}I="";C=0;w=0;D.searchInputID="form-"+D.formID+"-"+D.id;D.planeID=D.searchInputID+"-plane";a=e("#"+D.searchInputID);a.val("");var u=L();a.closest(".form-group").after(u);i=e("#"+D.planeID);l=e("#"+D.planeID+" .common-plane");o=e("#"+D.planeID+" .person-plane");f=e("#"+D.planeID+" .group-plane");c=e("#"+D.planeID+" .history-plane");d=e("#"+D.planeID+" .result-plane");$inputBtns=a.parent().children("[ns-control]");r=a.parent().children('[ns-control="personInfo"]');s=a.parent().children('[ns-control="groupInfo"]');t=a.parent().children('[ns-control="historyInfo"]');a.on("focus",function(e){if(C==0){S();if(D.isUsedHistory){$("histry")}else{$("person")}oe()}if(C==1){V()}});r.on("click",function(e){S();$("person");oe()});s.on("click",function(e){S();$("group");oe()});t.on("click",function(e){S();$("histry");oe()})}else{nsalert("人员选择器配置参数错误","error");return false}}function S(){a.parent().children(".has-error").remove();if(i.hasClass("show")){}else{i.addClass("show");a.on("keyup",F);e(document).on("keyup",T);O=true}}function T(e){switch(e.keyCode){case 32:if(a.val().indexOf(" ")>-1){var n=o.children(".current");if(n.length==1){var r=parseInt(n.attr("ns-psindex"));_(r);a.select()}}break;case 40:var n=o.children(".current");if(n.length==1){var s=false;function t(e){if(e.next().attr("class")=="plane-content"){s=e.next()}else{if(e.next().length!=0){t(e.next())}else{if(e.hasClass("plane-title")){B(w+1)}}}}t(n);if(s!=false){s.addClass("current");n.removeClass("current")}}break;case 38:var n=o.children(".current");if(n.length==1){var i=false;function l(e){if(e.prev().attr("class")=="plane-content"){i=e.prev()}else{if(e.prev().length!=0){l(e.prev())}else{B(w-1)}}}l(n);if(i!=false){i.addClass("current");n.removeClass("current")}}break;case 39:B(w+1);break;case 37:B(w-1);break;case 13:P();break;default:break}}function H(){if(v.length==1){a.blur();v.addClass("blur");v.one("click",function(e){v.removeClass("blur");a.focus()})}}function N(){if(i.hasClass("show")){i.removeClass("show");a.off("keyup",F);e(document).off("keyup",T);$inputBtns.filter(".current").removeClass("current");O=false;H();C=0}else{console.log("已经关了")}}function P(){if(i.hasClass("show")){N();if(D.isUsedHistory){U()}if(typeof D.handler=="function"){D.handler(k)}}else{console.log("已经关了")}}function U(){if(k.length>0||j.length>0){var n="person-select-"+D.id;var a=store.get(n);var r=[];for(var s=0;s<k.length;s++){r.push(k[s][D.personAjax.idIndex])}var t=[];for(var i=0;i<j.length;i++){t.push(j[i][D.groupAjax.valueField])}newHistory={};newHistory.person=r;newHistory.group=t;newHistory.time=(new Date).getTime();if(e.isArray(a)==false){store.set(n,[newHistory])}else{var l=-1;var o=[];var f=e.extend([],r);f.sort();var u=f.join("");var p=e.extend([],t);p.sort();var c=p.join("");for(var d=0;d<a.length;d++){var v=e.extend([],a[d].person);v.sort();var h=v.length>0?v.join(""):"";var g=e.extend([],a[d].group);g.sort();var x=g.join("");if(h==u&&x==c){l=d;o.push(d)}}if(l!=-1){a.splice(l,1)}if(a.length>=10){a.splice(9,1)}a.unshift(newHistory);store.set(n,a)}}}function F(n){var r=false;if(I==e.trim(a.val())){r=true}else{I=e.trim(a.val())}switch(C){case 0:case 1:case 3:if(!r){x=Y(I);V(true);if(C!=1){$("person")}}break}}function B(e){if(e>Math.ceil(x.length/10)-1){nsalert("已经是最后一页了")}else if(e<0){nsalert("已经是第一页了")}else{V(true,e);w=e}}function Y(e){var n=[];if(e!=""){for(var a=0;a<g.length;a++){var r=false;for(var s=0;s<D.personAjax.dataSearch.length;s++){var t=g[a][D.personAjax.dataSearch[s]];if(typeof t!="string"){t=t.toString()}t=t.toLocaleUpperCase();e=e.toLocaleUpperCase();if(t.indexOf(e)>-1){r=true}}if(r){n.push(g[a])}}}else{n=g}w=0;return n}function $(e){var n=false;switch(e){case"person":C=1;if(!o.hasClass("show")){l.filter(".show").removeClass("show");o.addClass("show");$inputBtns.filter(".current").removeClass("current");r.addClass("current");V()}break;case"group":C=2;if(!f.hasClass("show")){l.filter(".show").removeClass("show");f.addClass("show");$inputBtns.filter(".current").removeClass("current");s.addClass("current")}break;case"histry":C=3;if(!c.hasClass("show")){l.filter(".show").removeClass("show");c.addClass("show");$inputBtns.filter(".current").removeClass("current");t.addClass("current")}break}}function L(){var e="";var n="";var a="";var r="";var s="";n=q(0);a=M();var t="";if(D.column>=9){t='style="right:328px;"'}if(D.isUsedHistory){r=K();r='<div class="history-plane common-plane">'+r+"</div>"}e='<div class="person-select-plane" '+t+' id="'+D.planeID+'">'+'<div class="person-plane common-plane">'+n+"</div>"+'<div class="group-plane common-plane">'+a+"</div>"+r+'<div class="result-plane">'+s+"</div>"+"</div>";return e}function M(){var e="";if(y==false){e=J();setTimeout(te,200)}else{e='<div class="tree-plane">'+'<ul id="'+D.id+"-treeul"+'" class="ztree"></ul>'+"</div>"+'<div class="group-person-plane">'+"</div>"}return e}function q(e){var n="";if(x.length==0){n=G("不能获取人员信息")}else if(x==false){n=J();setTimeout(X,200)}else{var a=0;var r=10;var s=0;var t=0;var i=false;if(typeof e=="undefined"){e=w}if(typeof e=="number"){a=e*10;r=a+10;if(r>x.length){i=true;s=x.length;t=r;r=x.length}}for(var l=a;l<r;l++){n+=z(x[l],l)}if(i){for(var o=s;o<t;o++){n+=z("",o)}}n=n+W(x,a)}return n}function W(e,n){var a="";for(var r=0;r<D.personAjax.columnTitle.length;r++){var s=D.personAjax.columnTitle[r];var t=D.personAjax.columnWidth[r];a+='<span style="width:'+t+'">'+s+"</span>"}a='<div class="plane-content plane-title"><span>&nbsp;</span>'+a+"</div>";a+=ge(e,n);return a}function z(e,n){var a="";for(var r=0;r<D.personAjax.columnData.length;r++){var s=e==""?"":e[D.personAjax.columnData[r]];var t=D.personAjax.columnWidth[r];if(I!=""){if(typeof s!="string"){s=s.toString()}if(s.indexOf(I)>-1){s=s.substring(0,s.indexOf(I))+"<b>"+I+"</b>"+s.substring(s.indexOf(I)+I.length,s.length)}}a+='<span style="width:'+t+'">'+s+"</span>"}var i=e[1];var l="";if(e!=""){if(e[D.mark].isInRusult){l=" disabled"}}else{l=" empty"}a='<div class="plane-content'+l+'" ns-psvalue="'+i+'" ns-psindex="'+e[0]+'">'+'<a href="javascript:void(0);">'+"<span>"+(n+1)+"</span>"+a+"</a>"+"</div>";return a}function V(n,r){o.html(q(r));o.find(".state .page span.able").on("click",function(n){var a=e(this).attr("ns-psvalue");if(a=="+1"){B(w+1)}else if(a=="-1"){B(w-1)}});var s=a.is(":focus");if(s){o.children('[class="plane-content"]').eq(0).addClass("current")}o.children(".plane-content").not(".empty").not(".disabled").on("click",function(n){var a=parseInt(e(this).attr("ns-psindex"));_(a)})}function K(){var n="";var a='<div class="empty">'+'<i class="fa fa-history" aria-hidden="true"></i>'+"<p>您还没有保存过历史记录，系统会自动为您保存最近的十条记录</p>"+"</div>";if(g==false){n=J()}else{if(e.isArray(A)){if(A.length>0){for(var r=0;r<A.length;r++){n+=Q(A[r],r)}}else{n=a}}else{n=a}}return n}function Q(e,n){var a="";var r=[];for(var s=0;s<e.person.length;s++){for(var t=0;t<g.length;t++){var i=false;if(g[t][D.personAjax.idIndex]==e.person[s]){r.push(g[t])}}}var l="";for(var o=0;o<r.length;o++){l+=r[o][D.personAjax.nameIndex]+" "}var f={};f.person=r;b.push(f);var u=e.time;u=moment(u).format("YYYY-MM-DD HH:mm:ss");a+='<span class="name" >'+'<i class="personNum">'+e.person.length+"</i>"+l+"</span>";a+='<span class="time" >'+u+"</span>";var p="";if(e==""){p=" empty"}a='<div class="plane-content'+p+'" ns-psvalue="'+n+'" ns-psindex="'+n+'">'+'<a href="javascript:void(0);">'+"<span>"+(n+1)+"</span>"+a+"</a>"+"</div>";return a}function E(){c.html(K());c.children(".plane-content").on("click",function(n){var a=parseInt(e(this).attr("ns-psvalue"));for(var r=0;r<b[a].person.length;r++){_(b[a].person[r][0])}})}function G(e){var n='<div class="has-error"><p class="tips">'+e+"</p></div>";return n}function J(e){var n='<div class="loading">'+'<i class="fa fa-refresh fa-spin"></i>'+"<p>正在加载...</p>"+"</div>";return n}function X(){var e=D.personAjax.localDataConfig;var n=0;var a=[];var r=[];var s=[];var t=[];var i=[];var l=[];var o=[];var f=0;var u=0;var p=-1;var c=-1;var d=1;for(var v=0;v<e.length;v++){if(e[v].visible){s[e[v].visible-1]=v;n++}var h=typeof e[v].search=="undefined"?false:e[v].search;if(h){i.push(v)}if(e[v].key){l.push(e[v].key)}else{l.push(-1)}if(e[v].title){o.push(e[v].title)}else{o.push("")}var g=typeof e[v].isDepart=="undefined"?false:e[v].isDepart;if(g){p=v}var m=typeof e[v].isName=="undefined"?false:e[v].isName;if(m){c=v}var y=typeof e[v].isID=="undefined"?false:e[v].isID;if(y){d=v}}for(var A=0;A<s.length;A++){var b=e[s[A]];a.push(b.title);r.push(b.type);if(typeof b.width=="undefined"){f++}else if(typeof b.width=="number"){u+=b.width}else{nsalert("宽度参数错误","error")}t.push(b.width)}if(f>0){if(u<=100){var k=parseInt((100-u)/f*1e3)/1e3+"%";for(var j=0;j<t.length;j++){if(typeof t[j]=="undefined"){t[j]=k}else{t[j]=t[j]+"%"}}}else{nsalert("宽度设置错误，请设置为数字，总和不大于100")}}D.personAjax.columnData=s;D.personAjax.columnType=r;D.personAjax.columnNum=n;D.personAjax.columnWidth=t;D.personAjax.columnTitle=a;D.personAjax.groupIndex=p;D.personAjax.nameIndex=c;D.personAjax.idIndex=d;D.personAjax.dataSearch=i;D.personAjax.dataKey=l;D.personAjax.dataTitle=o;if(x==false){Z()}}function Z(){var n=typeof D.personAjax.data=="undefined"?"":D.personAjax.data;var r=typeof D.personAjax.type=="undefined"?"POST":D.personAjax.type;e.ajax({url:D.personAjax.url,data:n,type:r,dataType:"json",success:function(n){if(n.success){g=n[D.personAjax.dataSrc];var r=D.value;var s=e.isArray(r);var t=false;var i=[];if(s){if(r.length>0){t=e.isArray(r[0])}else{s=false}}var l=false;if(s==true&&t==false){l=true}for(var f=0;f<g.length;f++){var u={};if(l){for(var p=0;p<r.length;p++){if(g[f][D.personAjax.idIndex]==r[p]){u.isInRusult=true;k.push(g[f])}}}g[f].push(u)}if(g.length>0){D.mark=g[0].length-1}D.personAjax.personData=g;x=g;V(false,0);if(l==false&&s){for(var p=0;p<r.length;p++){g[r[p][0]][D.mark].isInRusult=true;k.push(r[p])}}if(s){a.val("");H()}ne();if(D.isUsedHistory){if(A==false){var c="person-select-"+D.id;A=store.get(c)}E()}}else{var d=G(n.msg);o.html(d)}}})}function _(e){if(g[e][D.mark].isInRusult!=true){k.push(g[e]);g[e][D.mark].isInRusult=true;if(g[e][D.mark].isInChecked==true){g[e][D.mark].isInChecked=false}V(true);ne()}else{}}function ee(){var e="";if(k.length==0){e='<div class="empty">还没有选择人员</div>'}else{for(var n=0;n<k.length;n++){e+='<span class="person-label" ns-psindex="'+k[n][0]+'">'+k[n][D.personAjax.nameIndex]+'<a href="javascript:void(0);" class="close"></a>'+"</span>"}}var a="btn-success";if(k<=0){a="btn-gray"}e+='<div class="btn-plane">'+'<button type="button" class="btn '+a+'" ns-psvalue="confirm">确定</button>'+'<button type="button" class="btn btn-white" ns-psvalue="cancel">取消</button>'+"</div>";return e}function ne(){d.html(ee());d.children(".person-label").on("click",function(n){var a=parseInt(e(this).attr("ns-psindex"));ae(a)});d.find(".btn-plane .btn").on("click",function(n){var a=e(this).attr("ns-psvalue");if(a=="cancel"){N()}else if(a=="confirm"){if(e(this).attr("class").indexOf("success")>-1){P()}else{nsalert("您还没有选择人员","warning")}}});var n=se();if(a.parent().children(".person-select-inputmask").length==0){var r="";if(D.isUsedHistory==false){r=' style="right:68px"'}a.after('<div class="person-select-inputmask"'+r+"></div>");v=a.parent().children(".person-select-inputmask")}v.html(n);h=v.children("a.close");h.on("click",function(e){re()})}function ae(e){g[e][D.mark].isInRusult=false;for(var n=0;n<k.length;n++){if(g[e]==k[n]){k.splice(n,1)}}ne();if(C==1){V()}else if(C==2){f.find(".curSelectedNode").click()}}function re(){for(var e=0;e<k.length;e++){g[k[e][0]][D.mark].isInRusult=false}k=[];D.resultPersonArr=k;ne();if(C==1){V()}return true}function se(){var e="";if(k.length==0){e=""}else if(k.length==1){e=k[0][D.personAjax.nameIndex];e='<span class="name">'+e+"</span>"}else{e=k[0][D.personAjax.nameIndex];e+="、";e+=k[1][D.personAjax.nameIndex];if(k.length>2){e+="等"}e='<span class="name">'+e+"</span>"}var n=e+'<span style="display: inline;">共'+k.length+"人</span>"+'<a class="close" id="close" style="display: inline;"></a>';if(k.length==0){n=""}return n}function te(){var n=typeof D.groupAjax.data=="undefined"?"":D.groupAjax.data;var a=typeof D.groupAjax.type=="undefined"?"POST":D.groupAjax.type;e.ajax({url:D.groupAjax.url,data:n,type:a,dataType:"json",success:function(n){if(n.success){m=ie(n[D.groupAjax.dataSrc]);y=m;le();f.html(M());u=e("#"+D.planeID+" .group-plane .group-person-plane");p=u.find(".group-person-select-button");if(C==2){oe()}}}})}function ie(e){var n={};n[D.groupAjax.textField]="全部";n[D.groupAjax.valueField]="-1";n.open=true;n.children=e;function a(e){for(var n=0;n<e.length;n++){var r=e[n]["children"];var s=true;if(Number(r)==0){s=false}else if(r==null){s=false}e[n].isParent=s;e[n].name=e[n][D.groupAjax.textField];e[n].id=e[n][D.groupAjax.valueField];if(s){a(e[n].children)}}}a(n.children);return n}function le(){D.treeSetting={data:{simpleData:{enable:true}},check:{enable:true,chkboxType:{Y:"s",N:"s"}},view:{expandSpeed:""},callback:{onClick:fe,onCheck:ue}}}function oe(){e.fn.zTree.init(e("#"+D.id+"-treeul"),D.treeSetting,y)}function fe(e,n,a,r){var s=a[D.groupAjax.valueField];pe(s,a,0)}function ue(e,n,a){var r=a[D.groupAjax.valueField];pe(r,a,0,true)}function pe(n,a,r,s){if(typeof n!="string"){n=n.toString()}var t=[];for(var i=0;i<g.length;i++){if(g[i][D.personAjax.groupIndex]==n){t.push(g[i]);if(typeof s=="boolean"){g[i][D.mark].isInChecked=s}if(g[i][D.mark].isInChecked==true){isNeedAdd=true}}}var l=he(t,a,r);u.html(l);p=u.find(".group-person-select-button");u.children(".group-person-list").children(".plane-content").not(".disabled").on("click",function(n){var a=e(this);var r=parseInt(a.attr("ns-psindex"));var s=(new Date).getTime();if(typeof a.attr("ns-timestamp")!="undefined"){var t=parseInt(a.attr("ns-timestamp"));if(s-t>500){if(a.hasClass("checked")){ve(r)}else{de(r)}}else{ce(r)}}else{de(r)}a.attr("ns-timestamp",s);var i=u.children(".group-person-list").children(".checked").length;if(i>0){p.addClass("able")}else{p.removeClass("able")}});p.on("click",function(n){if(e(this).hasClass("able")){var a=u.children(".group-person-list").children(".checked");for(var r=0;r<a.length;r++){var s=parseInt(a.eq(r).attr("ns-psindex"));ce(s)}}})}function ce(e){var n=u.find('[ns-psindex="'+e+'"]');n.removeClass("checked");n.addClass("disabled");n.off("click");_(e)}function de(e){var n=u.find('[ns-psindex="'+e+'"]');g[e][D.mark].isInChecked=true;n.addClass("checked")}function ve(e){var n=u.find('[ns-psindex="'+e+'"]');g[e][D.mark].isInChecked=false;n.removeClass("checked")}function he(e,n,a){var r="";var s=false;if(e.length>0){var t=a+10;if(t>e.length){t=e.length}for(var i=a;i<t;i++){var l="";if(e[i][D.mark].isInRusult){l=" disabled"}else if(e[i][D.mark].isInChecked){l=" checked";if(e[i][D.mark].isInRusult==false){s=true}}r+='<div class="plane-content '+l+'" ns-psindex="'+e[i][0]+'">'+'<a href="javascript:void(0);">'+"<span>"+(i+1)+"</span>"+"<span>"+e[i][D.personAjax.nameIndex]+"</span>"+"</a>"+"</div>"}}r='<div class="group-person-list">'+'<div class="plane-content plane-title">'+"<span>"+n[D.groupAjax.textField]+"</span>"+"</div>"+r+"</div>";var o=ge(e,a);var f="";if(e.length>0){var u="";if(s){u=" able"}f='<button type="button" class="btn btn-white group-person-select-button'+u+'"><i class="fa fa-arrow-circle-right"></i></button>'}r=r+o+f;return r}function ge(e,n){var a="";if(e.length>0){var r="able";var s="able";var t=n+10;if(t>e.length){t=e.length-1}if(n==0){r="disabled"}if(t==e.length-1){s="disabled"}var i=n/10+1;var l=Math.ceil(e.length/10);a='<div class="state">'+'<div class="page">'+'<span class="'+r+'" ns-psvalue="-1"><i class="fa fa-angle-left" aria-hidden="true"></i></span>'+"<span>"+i+"/"+l+"</span>"+'<span class="'+s+'" ns-psvalue="+1"><i class="fa fa-angle-right" aria-hidden="true"></i></span>'+"</div>"+"<span>共："+e.length+"条</span>"+"</div>"}else{a='<div class="state-empty">没有数据</div>'}return a}function xe(e){var n=true;if(e.sRules){var r="";if(e.sRules.indexOf("required")>-1){n=e.resultPersonArr.length>0;r="必填"}if(e.sRules.indexOf("range")>-1){var s=e.sRules.substring(e.sRules.indexOf("range"),e.sRules.length);if(s.indexOf(" ")>-1){s=s.substring(s.indexOf("range"),s.indexOf(" "))}var t=s.substring(s.indexOf("[")+1,s.indexOf(","));t=parseInt(t);var i=s.substring(s.indexOf(",")+1,s.indexOf("]"));i=parseInt(i);if(e.resultPersonArr.length>=t&&e.resultPersonArr.length<=i){}else{n=false;r="有效数量是"+t+"到"+i+"个"}}if(e.sRules.indexOf("max")>-1){var l=nsVals.getRuleNumber(e.sRules,"max");if(e.resultPersonArr.length>l){n=false;r="最大数量是"+l+"个"}}}if(n==false){var o="";if(e.isUsedHistory==false){o='style="right:98px;"'}else{o='style="right:128px;"'}var f='<label class="has-error" '+o+">"+r+"</label>";a.after(f)}return n}function me(e){}function ye(){n=undefined;a=undefined;r=undefined;s=undefined;t=undefined;i=undefined;l=undefined;o=undefined;f=undefined;u=undefined;p=undefined;c=undefined;d=undefined;v=undefined;h=undefined;g=[];x=[];m=[];y=[];A=[];b=[];k=[];j=[];I="";C=undefined;w=undefined;D=undefined;O=false}function Ae(){re();ye()}return{init:R,isValid:xe,clear:re,getData:me,reset:Ae}}(jQuery);
nsUI.projectAndTree=function(e){var t;var n;var r;var a;function c(c){if(typeof c!="object"){nsalert("配置参数错误","error");return false}t=c;t.planeID=t.id+"-projectAndTreePlane";var d=i();e("body").append(d);t.$container=e("#"+t.planeID+" div.container-project");nsUI.projectSelect.init(t);t.$treeContainer=t.treeAjax.$treeContainer=e("#"+t.planeID+" div.container-tree");if(t.treeAjax.clickCallback){t.treeAjax.clickHandler=o}if(t.treeAjax.checkCallback){t.treeAjax.checkHandler=s}t.treeAjax.id=t.id;t.treeAjax.treeID=t.id+"-tree";nsUI.treePlane.init(t.treeAjax);n=e("#"+t.planeID+">a.ps-close-btn");a=e("#"+t.planeID+">.ps-btn .btn-success");r=e("#"+t.planeID+">.ps-btn .btn-white");a.on("click",function(e){var n=nsUI.treePlane.getCheckIDs(t.id);var r=nsUI.treePlane.getCheckedData(t.id);var a=nsUI.projectSelect.getDataIDs();var c=nsUI.projectSelect.getData();var i={};i.treeStr=n;i.treeArr=r;i.projectStr=a;i.projectArr=c;if(typeof t.confirmHandler=="function"){t.confirmHandler(i)}else{nsalert("confirmHandler参数错误，必须是function","error")}});n.on("click",l);r.on("click",l)}function i(){var e='<div class="project-tree-plane" id="'+t.planeID+'">'+'<div class="title-tree">'+t.treeTitle+"： </div>"+'<div class="container-project"></div>'+'<div class="container-tree"></div>'+'<a class="ps-close-btn" href="javascript:void(0);">x</a>'+'<div class="ps-btn"><button class="btn btn-success"><i class="fa fa-check"></i> 确认</button><button class="btn btn-white">取消</button></div>'+"</div>";return e}function l(n){nsUI.projectSelect.clear();e("#"+t.planeID).remove();t=undefined}function o(e,n){if(typeof t.treeAjax.clickCallback=="function"){t.treeAjax.clickCallback(e,n)}}function s(e,n){if(typeof t.treeAjax.checkCallback=="function"){t.treeAjax.checkCallback(e,n)}}return{init:c,close:l}}(jQuery);
nsUI.treePlane=function(e){var n;var t;var i;var a={};function r(e){n=e;a[n.id]={};s();f()}function l(e,t){var i="parentId="+t.id;var a=n.url;n.data.parentId=t.id;return a+"?"+i}function c(e,n,t){var i=u(t);return i}function d(e,n,t,i){}function s(){setting={data:{simpleData:{enable:true}},check:{enable:true,chkboxType:{Y:"s",N:"s"}},view:{expandSpeed:""},callback:{}};if(n.clickHandler){setting.callback.onClick=h}if(n.checkHandler){setting.callback.onCheck=v}var e=n.async?n.async:false;if(e){setting.async={enable:true,url:l,dataFilter:c,type:n.type}}if(n.isCheck){setting.check={enable:true,chkboxType:{Y:"s",N:"s"}}}if(n.isRadio){setting.check={enable:true,chkStyle:"radio",radioType:"all"}}setting.callback.onAsyncSuccess=d;n.setting=setting}function u(e){var t={};t[n.textField]="全部";t[n.valueField]="-1";t.name="全部";t.id="-1";t.isParent=e.length>0;t.open=true;t.children=e;function i(e){if(e){for(var t=0;t<e.length;t++){var a=e[t][n.haschildField];var r=true;if(a){if(Number(a)==0){r=false}else if(a==null){r=false}}else{if(e[t]["children"]==null){r=false}else if(e[t]["children"].length==0){r=false}}e[t].isParent=r;e[t].name=e[t][n.textField];e[t].id=e[t][n.valueField];if(r){i(e[t].children)}}}}i(t.children);return t}function f(){var t=typeof n.data=="undefined"?"":n.data;var a=typeof n.type=="undefined"?"POST":n.type;e.ajax({url:n.url,data:t,type:a,dataType:"json",success:function(e){if(e.success){var t=u(e[n.dataSrc]);i=t;o()}}})}function o(){var t='<ul id="'+n.treeId+'" class="ztree"></ul>';n.$treeContainer.html(t);e.fn.zTree.init(e("#"+n.treeId),n.setting,i)}function h(e,t,i,a){n.clickHandler(i,n.id)}function v(e,t,i){if(i.checked){a[n.id][i.id]=i}else{if(a[n.id][i.id]){delete a[n.id][i.id]}}n.checkHandler(i,n.id,a[n.id])}function k(e){return a[e]}function p(n){var t=[];var i="";if(a[n]){e.each(a[n],function(e,n){t.push(e)})}else{nsalert("id:"+n+"的数据不存在","error")}if(t.length>0){t=t.sort();i=t.join(",")}else{i=false}return i}return{init:r,getCheckedData:k,getCheckIDs:p}}(jQuery);
nsUI.keyboard=function(n){for(var e in n){var r=n[e];$.each(r,function(n,e){var r=/[\+]+/.test(n)?n.replace("+","_"):n;$(document).bind("keydown",n,function n(r){var a=e;a();return false})})}};function keyboardPlane(n){for(var e in n){var r=n[e];$.each(r,function(n,e){var r=/[\+]+/.test(n)?n.replace("+","_"):n;$(document).bind("keydown",n,function n(r){var a=e;a();return false})})}}
nsUI.chart=function(t,a){var e=t.data;var i=[];var s=t.yAxisField;var r=t.yAxisName;var o=[];for(var h=0;h<e.length;h++){i.push(e[h][t.xAxisField])}if(typeof s=="object"){for(var l=0;l<s.length;l++){var n={};n.name=r[l];n.type=t.type;if(typeof t.yAxisStock=="object"){var x=t.yAxisStock;n.stack=x[l]}if(t.yAxisWidth){n.barWidth=Number(t.yAxisWidth)}n.label={normal:{show:true,position:"insideRight"}};n.data=[];for(var h=0;h<e.length;h++){n.data.push(e[h][s[l]])}o.push(n)}}var v={title:{text:t.title},tooltip:{},toolbox:{show:true,feature:{saveAsImage:{}}},legend:{data:r},xAxis:{data:i},yAxis:{},series:o};a.setOption(v)};var nsChartUI={};nsChartUI.init=function(t,a){var e=t.data;var i=[];var s=t.yAxisField;var r=t.yAxisName;var o=[];for(var h=0;h<e.length;h++){i.push(e[h][t.xAxisField])}if(typeof s=="object"){for(var l=0;l<s.length;l++){var n={};n.name=r[l];n.type=t.type;if(typeof t.yAxisStock=="object"){var x=t.yAxisStock;n.stack=x[l]}if(t.yAxisWidth){n.barWidth=Number(t.yAxisWidth)}n.label={normal:{show:true,position:"insideRight"}};n.data=[];for(var h=0;h<e.length;h++){n.data.push(e[h][s[l]])}o.push(n)}}var v={title:{text:t.title},tooltip:{},toolbox:{show:true,feature:{saveAsImage:{}}},legend:{data:r},xAxis:{data:i},yAxis:{},series:o};a.setOption(v)};
nsTree.config={};nsTree.json={};nsTree.tree={};nsTree.formConfig={};nsTree.selectJson={};nsTree.searchJson={};nsTree.currentItem={};nsTree.maxID=0;nsTree.newTreeNodeID=-100;nsTree.currentTreeID;var langTree=language.ui.nsTree;nsTree.initGetMenu=function(e,r,n){var t="";if(nsTree.config[n].dragMode){t='<div class="uk-nestable-handle"></div>'}var a=nsTree.config[n].controlForm.keyID;var o=nsTree.config[n].controlForm.keyParent;var s=nsTree.config[n].controlForm.keyText;var l='<li data-parentid="'+e[o]+'" data-name="'+e[s]+'" data-id="'+e[a]+'">'+'<div class="list-content uk-nestable-item">'+t+'<div class="uk-nestable-toggle" data-nestable-action="toggle"></div>'+'<div class="list-label">'+e[s]+"</div>"+"</div>"+r+"</li>";return l};nsTree.initConfig=function(e){if(typeof e.type=="undefined"){e.type="get"}if(typeof e.data=="undefined"){e.data=""}if(typeof e.dataSrc=="undefined"){e.dataSrc="list"}if(typeof e.controlMode=="undefined"){e.controlMode="form"}else if(e.controlMode=="form"||e.controlMode=="dialog"||e.controlMode=="none"){}else{nsalert(initConfig.controlModeError,"error")}if(typeof e.controlForm=="undefined"){e.controlForm.keyID="id";e.controlForm.keyParent="parentId";e.controlForm.keyText="text";e.controlForm.keyOrderID="orderId";e.controlForm.formElement=[[]]}if(typeof e.ajaxMethod=="undefined"){e.ajaxMethod="post"}if(typeof e.selectMode=="undefined"){e.selectMode="single"}else{if(e.selectMode=="s"){e.selectMode="single"}else if(e.selectMode=="m"){e.selectMode="multiple"}else if(e.selectMode=="n"){e.selectMode="none"}else if(e.selectMode=="single"||e.selectMode=="multiple"||e.selectMode=="none"){}else{nsalert(lang.config.selectModeError,"error")}}if(typeof e.dragMode=="undefined"){e.dragMode=false}nsTree.currentTreeID=e.id;nsTree.currentItem={};nsTree.currentData=false;if(typeof e.addAjax=="function"){e.addAjax=e.addAjax()}if(typeof e.editAjax=="function"){e.editAjax=e.editAjax()}if(typeof e.deleteAjax=="function"){e.deleteAjax=e.deleteAjax()}if(typeof e.dragAjax=="function"){e.dragAjax=e.dragAjax()}if(typeof e.sortMoveAjax=="function"){e.sortMoveAjax=e.sortMoveAjax()}return e};nsTree.getExtendValue=function(e){var r=nsTree.currentItem.cItemID;var n=nsTree.currentItem.cTreeID;nsTree.getSearchJson(nsTree.json[n],r,n);var t=nsTree.searchJson[e.id];if(typeof t=="undefined"){t=""}if(t==null){t=""}return t};nsTree.init=function(e){var r=nsTree.initConfig(e);nsTree.config[r.id]=r;if(r.dialogMode!="none"){var n=e.controlForm.formElement;nsTree.initDialog(e)}var t={html:"<hr>"};var a=0;if(n){if($.isArray(n)){for(var o=0;o<n.length;o++){if($.isArray(n[o])){for(var s=0;s<n[o].length;s++){var l=jQuery.extend(true,{},n[o][s]);l.value=function(){return nsTree.getExtendValue(this)};var i=jQuery.extend(true,{},n[o][s]);i.value=function(){return nsTree.getExtendValue(this)};i.readonly=true;var d=jQuery.extend(true,{},n[o][s]);if(a==0){nsTree.dialogEditConfig.form.push(t);nsTree.dialogDeleteConfig.form.push(t);nsTree.dialogAddConfig.form.push(t)}a++;nsTree.dialogEditConfig.form.push(l);nsTree.dialogDeleteConfig.form.push(i);nsTree.dialogAddConfig.form.push(d)}}}}}if(r.controlMode=="form"){var c=$("#"+r.id).parent();if(r.isLayout==true){c=c.parent().parent()}var f=c.attr("class");var u="";if(typeof r.controlColWidth=="undefined"){var T=f.substr(f.lastIndexOf("col-sm-"),f.length);T=T.substring(0,T.indexOf(" "));var m=T.substr(T.lastIndexOf("-")+1,T.length);var g=12-Number(m);u=f.replace(m,g);if(u.indexOf("nspanel-left")>-1){u=u.replace("nspanel-left","")}if(u.indexOf("nspanel-right")>-1){u=u.replace("nspanel-right","")}}else{var I=Number(r.controlColWidth);if(/^(\+|-)?\d+$/.test(I)&&I>0&&I<=12){u=f.replace(m,r.controlColWidth)}else{nsalert(langTree.initConfig.colWidthError);return false}}c.parent().addClass("form-content");var v="";var p=typeof c.attr("style")!="undefined"?c.attr("style"):"";var h='<div class="'+u+'" style="'+p+'">'+'<div id="controlPlane-'+r.id+'" class="nspanel-control"></div>'+"</div>";c.after(h);var D={};D.form=r.controlForm.formElement;for(var y=0;y<D.form.length;y++){for(var x=0;x<D.form[y].length;x++){D.form[y][x].column=12;if(D.form[y][x].type=="checkbox"||D.form[y][x].type=="radio"){for(var b=0;b<D.form[y][x].subdata.length;b++){D.form[y][x].subdata[b].isDisabled=true}}D.form[y][x].readonly=true;D.form[y][x].placeholder="";delete D.form[y][x].rules}}var k={id:r.controlForm.keyParent,label:langTree.dialog.nodeParentLable,type:"text",readonly:true,placeholder:"",column:12};var j={id:r.controlForm.keyText,label:langTree.dialog.nodeNameLabel,type:"text",readonly:true,placeholder:"",column:12};var C={id:r.controlForm.keyOrderID,label:langTree.dialog.nodeSortLable,readonly:true,type:"text",placeholder:"",column:12};var M=[k,j,C];D.form.unshift(M);D.id="controlPlane-"+r.id;D.formConfigsize="standard";D.format="standard";D.fillbg=true;nsTree.formConfig[r.id]=D;formPlane.formInit(D)}$.ajax({url:r.src,type:r.type,data:r.data,dataType:"json",success:function(e){if(e.success==true){var n=e[r.dataSrc];if($.isEmptyObject(n)){nsalert(langTree.initConfig.emptyData,"warning")}nsTree.json[r.id]=n;var t="";for(var a=0;a<n.length;a++){var o="";if(n[a].children){o=nsTree.secondMenuJson(n[a].children,r.id)}t+=nsTree.initGetMenu(n[a],o,r.id)}var s="";if(r.dragMode){s="with-drag"}else{s="without-drag"}var l='<ul id="'+r.id+'_nsTree" class="uk-nestable '+s+'" data-uk-nestable>'+t+"</ul>";$("#"+r.id).html(l);nsTree.actionEvent(r.id)}else{nsalert(language.common.returnError)}},error:function(){nsalert(language.common.returnError)}})};nsTree.iterateList=function(e,r){var n={};var t=new Array;if(!r)r=0;for(var a=0;a<e.length;a++){n[a]=e[a]}return n};nsTree.expandAll=function(e){var r=e;if(r==undefined){var n=0;for(tree in nsTree.tree){n++;r=tree}if(n!=1){nsalert("当前页面有多个目录树组件，需要指定treeID");return false}}nsTree.tree[r].expandAll()};nsTree.collapseAll=function(e){var r=e;if(r==undefined){var n=0;for(tree in nsTree.tree){n++;r=tree}if(n!=1){nsalert("当前页面有多个目录树组件，需要指定treeID");return false}}nsTree.tree[r].collapseAll()};nsTree.dragTempData=[];nsTree.actionEvent=function(e){var r="#"+e+"_nsTree";nsTree.tree[e]=$.UIkit.nestable(r,{});nsTree.tree[e].collapseAll();$(r).on("nestable-start",function(e){nsTree.dragTempData=[];for(var r=0;r<$(this).data("nestable").list().length;r++){nsTree.dragTempData.push($(this).data("nestable").list()[r].id)}});if(nsTree.config[e].selectMode!="none"){$(r+" .list-content").off("click");$(r+" .list-content").on("click",nsTree.selectHandler)}if(nsTree.config[e].dragMode){$(r).off("nestable-stop");$(r).on("nestable-stop",function(r){var n=[];var t=nsTree.tree[e].list();var a=-1;for(var o=0;o<t.length;o++){var s=$.inArray(t[o].id,nsTree.dragTempData);if(s==-1){a=o}}var l={};var i=t[a];$.each(i,function(r,n){if(r=="id"){l[nsTree.config[e].controlForm.keyID]=n}else if(r=="parent_id"){if(n==null){l[nsTree.config[e].controlForm.keyParent]=-1}else{l[nsTree.config[e].controlForm.keyParent]=n}}else if(r=="order"){l[nsTree.config[e].controlForm.keyOrderID]=n+1}});$.ajax({type:nsTree.config[e].ajaxMethod,url:nsTree.config[e].dragAjax,data:l,dataType:"json",success:function(e){if(e.success){nsalert("目录排序成功");$('li[data-id="'+i.id+'"]').attr("data-parentid",i.parent_id)}else{nsalert("目录排序失败，请重试或者刷新页面")}},error:function(e){nsalert("目录排序失败，请重试或者刷新页面")}})})}};nsTree.getDomData=function(e,r){var n=$("li[data-id='"+e+"']");var t=n.parent().children("li");var a=0;for(var o=0;o<t.length;o++){if($(t[o]).attr("data-id")==e){a=o}}var s={};s.id=Number($(n).attr("data-id"));s.name=$(n).attr("data-name");s.parentid=Number($(n).attr("data-parentid"));s.order=a;return s};nsTree.getDialogOrder=function(){var e=nsTree.getDomData(nsTree.currentItem.cItemID,nsTree.currentItem.cTreeID);return e.order+1};nsTree.getBaseData=function(e,r){var n={};for(var t=0;t<nsTree.tree[r].list().length;t++){if(nsTree.tree[r].list()[t].id==e){n=nsTree.tree[r].list()[t]}}return n};nsTree.getSourceJson=function(e,r){var n=nsTree.json[r];var t;var a=function(n){for(var o=0;o<n.length;o++){if(n[o][nsTree.config[r].controlForm.keyID]==e){t=n[o];return}else{if(typeof n[o].children!="undefined"&&n[o].children!=null){a(n[o].children)}}}};a(n);return t};nsTree.getSearchJson=function(e,r,n){for(var t=0;t<e.length;t++){if(e[t][nsTree.config[n].controlForm.keyID]==r){nsTree.searchJson=e[t];return}else{if(typeof e[t].children!="undefined"&&e[t].children!=null){nsTree.getSearchJson(e[t].children,r,n)}}}};nsTree.getSearchDom=function(e,r){var n=$("#"+e+" .uk-nestable-list-item");var t;for(var a=0;a<n.length;a++){if($(n[a]).attr("data-id")==String(r)){t=n[a];return t}}};nsTree.secondMenuJson=function(e,r){var n=e;var t="";var a="";for(var o=0;o<n.length;o++){if(Number(n[o][nsTree.config[r].controlForm.keyID])>=nsTree.maxID){nsTree.maxID=Number(n[o][nsTree.config[r].controlForm.keyID])}var s="";if(n[o].children){s=nsTree.secondMenuJson(n[o].children,r)}a+=nsTree.initGetMenu(n[o],s,r)}var t="<ul>"+a+"</ul>";return t};nsTree.multipleSelectJson={};nsTree.selectHandler=function(e){if($(e.target).hasClass("uk-nestable-toggle")){return}var r=function(){var e=$("#"+o+"_nsTree").children("li");nsTree.currentItem={cTreeID:o,cItemID:"",cItemName:"",cItemParentID:-1,cItemParentName:langTree.dialog.rootName,cItemOrderID:"",cItemBrotherNumber:-1,cItemChildren:e.length}};var n=function(){var e=s.attr("data-id");var r=s.attr("data-name");var n=s.attr("data-parentid");var t=0;var a=s.parent().children("li");for(var l=0;l<a.length;l++){if($(a[l]).attr("data-id")==e){t=l}}var i=s.children("ul")?s.children("ul").children("li"):[];var d;if(n=="-1"){d=langTree.dialog.rootName}else{d=s.parent().closest("li.uk-nestable-list-item.uk-parent").attr("data-name")}nsTree.currentItem={cTreeID:o,cItemID:e,cItemName:r,cItemParentID:n,cItemParentName:d,cItemOrderID:t+1,cItemBrotherNumber:a.length,cItemChildrenNumber:i.length}};var t=false;var a=false;var o=$(this).closest(".uk-nestable").parent().attr("id");var s=$(this).closest("li.uk-nestable-list-item");if(nsTree.config[o].selectMode=="single"){a=true;if($(this).closest("li .uk-nestable-item").hasClass("item-selected")){t=true;$(this).closest("li .uk-nestable-item").removeClass("item-selected");r()}else{$("#"+o+" li .uk-nestable-item.item-selected").removeClass("item-selected");s.children(".uk-nestable-item").addClass("item-selected");n()}}else if(nsTree.config[o].selectMode=="multiple"){a=false;if($(this).closest("li .uk-nestable-item").hasClass("item-selected")){t=true;$(this).closest("li .uk-nestable-item").removeClass("item-selected");r();delete nsTree.multipleSelectJson[s.attr("data-id")]}else{s.children(".uk-nestable-item").addClass("item-selected");n();nsTree.multipleSelectJson[nsTree.currentItem.cItemID]=nsTree.currentItem}}var l=nsTree.getSourceJson(nsTree.currentItem.cItemID,nsTree.currentItem.cTreeID);if(nsTree.config[o].controlMode=="form"){var i={};var d=t?"":String(nsTree.currentItem.cItemOrderID);var c=t?"":nsTree.currentItem.cItemParentName;i[nsTree.config[o].controlForm.keyText]=nsTree.currentItem.cItemName;i[nsTree.config[o].controlForm.keyParent]=c;i[nsTree.config[o].controlForm.keyOrderID]=d;for(var f=1;f<nsTree.config[o].controlForm.formElement.length;f++){var u=nsTree.config[o].controlForm.formElement[f];for(var T=0;T<u.length;T++){if(t){i[u[T].id]=""}else{i[u[T].id]=l[u[T].id]}}}formPlane.fillValues(i,"controlPlane-"+o)}var m;if(typeof nsTree.config[o].selectHandler!="undefined"){if(a){if(t){m={}}else{m=l}}else{m=[];$.each(nsTree.multipleSelectJson,function(e,r){m.push(r)})}var g=nsTree.config[o].selectHandler;g(m)}if(t){nsTree.currentData=false}else{nsTree.currentData=m}};nsTree.currentData={};nsTree.add=function(){var e=nsdialog.getFormJson();if(e==false){nsalert("您填写的数据不完整","error");return false}var r=nsTree.currentTreeID;var n=nsTree.config[r].controlForm.keyID;var t=nsTree.config[r].controlForm.keyParent;var a=nsTree.config[r].controlForm.keyText;var o=nsTree.config[r].controlForm.keyOrderID;if($.isEmptyObject(nsTree.json[r])){$("#"+r).find(".uk-nestable-empty").remove()}var s=nsTree.getSearchDom(r,e[t]);if(typeof s=="undefined"){s=$("#"+r)}var l=$(s).children("ul").children("li").length;var i=$(s).children("ul").children("li");var d={};$.each(e,function(e,r){d[e]=r});delete d[o];delete e.addParentName;$.ajax({type:nsTree.config[r].ajaxMethod,url:nsTree.config[r].addAjax,data:e,dataType:"json",success:function(a){if(a.success){d[n]=String(a[n]);var l=nsTree.initGetMenu(d,"",r);if(e[t]==""||e[t]==-1){nsTree.json[r].push(d);$(s).children("ul").append(l)}else{var i=nsTree.getSourceJson(e[t],r);if(typeof i.children=="undefined"||i.children==null){i["children"]=[d];l='<ul class="uk-nestable-list">'+l+"</ul>";$(s).append(l);nsTree.tree[r].setParent($(s));nsTree.tree[r].expandItem($(s))}else{i.children.push(d);var c=e[o]-1-1;var f=$(s).children("ul").children("li");if(f.length==0){$(s).children("ul").html(l)}else{if(c>=0){$(f[c]).after(l)}else if(c==-1){$(f[0]).prepend(l)}}if($(s).hasClass("uk-collapsed")){nsTree.tree[r].expandItem($(s))}}}$('li[data-id="'+d[n]+'"]').addClass("uk-nestable-list-item");$('li[data-id="'+d[n]+'"] div.list-content').addClass("uk-nestable-item");$('li[data-id="'+d[n]+'"] .list-content').on("click",nsTree.selectHandler);if(typeof nsTree.config[r].addHandler=="function"){var u=nsTree.config[r].addHandler;u(a)}nsalert("目录添加成功");popupBox.hide()}else{nsalert("目录添加失败："+a.msg)}},error:function(e){nsalert("目录添加失败："+data.msg)}})};nsTree.dialogAddValue=function(e){var r={};if($.isEmptyObject(nsTree.currentItem)||nsTree.currentItem.cItemID==""){if($.isEmptyObject(nsTree.multipleSelectJson)){var n=0;var t="";$.each(nsTree.json,function(e,r){n++;t=e});if(e=="parentId"){if(n<=1){nsalert(langTree.dialog.defaultTreeText)}else{nsalert(langTree.dialog.defaultMoreTreeText)}}r.parentName=langTree.dialog.rootName;r.parentId=-1;var a=$("#"+t+"_nsTree").children("li");r.sortId=a.length+1;return r[e]}else{var o=0;$.each(nsTree.multipleSelectJson,function(e,r){o++;nsTree.currentItem=nsTree.multipleSelectJson[e]});if(e=="parentId"){if(o>1){nsalert(langTree.dialog.defaultMoreNodeText,"warning")}}r.parentName=nsTree.currentItem.cItemName;r.parentId=nsTree.currentItem.cItemID;r.sortId=nsTree.currentItem.cItemChildrenNumber+1;return r[e]}}else{var o=0;$.each(nsTree.multipleSelectJson,function(e,r){o++});if(e=="parentId"){if(o>1){nsalert(langTree.dialog.defaultMoreNodeText,"warning")}}r.parentName=nsTree.currentItem.cItemName;r.parentId=nsTree.currentItem.cItemID;r.sortId=nsTree.currentItem.cItemChildrenNumber+1;return r[e]}};nsTree.dialogAdd=function(){popupBox.initShow(nsTree.dialogAddConfig)};nsTree.getDialogID=function(){var e=nsTree.currentItem.cItemID;return e};nsTree.getDialogName=function(){var e=nsTree.currentItem.cItemName;return e};nsTree.del=function(){var e=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyID;var r=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyParent;var n=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyText;var t={};if(nsTree.config[nsTree.currentItem.cTreeID].deleteAjaxData){t=nsTree.config[nsTree.currentItem.cTreeID].deleteAjaxData}t[e]=nsTree.currentItem.cItemID;var a=nsTree.getSearchDom(nsTree.currentItem.cTreeID,nsTree.currentItem.cItemID);if(typeof a=="undefined"){a=$("#"+nsTree.currentItem.cTreeID)}$.ajax({type:nsTree.config[nsTree.currentItem.cTreeID].ajaxMethod,url:nsTree.config[nsTree.currentItem.cTreeID].deleteAjax,data:t,dataType:"json",success:function(r){if(r.success){var n;if(nsTree.currentItem.cItemParentID!=-1){nsTree.getSearchJson(nsTree.json[nsTree.currentItem.cTreeID],nsTree.currentItem.cItemParentID,nsTree.currentItem.cTreeID);n=nsTree.searchJson.children}else{n=nsTree.json[nsTree.currentItem.cTreeID]}var t;for(var a=0;a<n.length;a++){if(n[a][e]==nsTree.currentItem.cItemID){t=a}}n.splice(t,1);nsalert("目录删除成功");$('li[data-id="'+nsTree.currentItem.cItemID+'"]').remove();if(typeof nsTree.config[nsTree.currentItem.cTreeID].delHandler!="undefined"){var o=nsTree.config[nsTree.currentItem.cTreeID].delHandler;o(r)}nsTree.currentItem={};nsTree.currentData=false;nsdialog.hide()}else{if(typeof nsTree.config[nsTree.currentItem.cTreeID].delHandler!="undefined"){var o=nsTree.config[nsTree.currentItem.cTreeID].delHandler;o(r)}nsalert("目录删除失败，请重试或者刷新页面")}},error:function(e){nsalert("目录删除失败，请重试或者刷新页面")}})};nsTree.sortMove=function(e,r){if(typeof nsTree.config[e]=="undefined"){nsalert("nsTree.sortMove treeID参数错误："+e);return false}var n=$("#"+e).find("div.item-selected");if(n.length==0){nsalert("请先选择要修改顺序的节点","warning");return false}if(r!="up"&&r!="down"){nsalert("nsTree.sortMove direction参数错误："+r+" ，只能是up和down");return false}var t;if(r=="up"){t=n.parent().prev()}else if(r=="down"){t=n.parent().next()}if(t.length>0){var a;if(nsTree.config[nsTree.currentItem.cTreeID].sortAjaxData){a=nsTree.config[nsTree.currentItem.cTreeID].sortAjaxData}else{a={}}a.currentID=n.parent().attr("data-id");a.targetID=t.attr("data-id");$.ajax({type:nsTree.config[nsTree.currentItem.cTreeID].ajaxMethod,url:nsTree.config[nsTree.currentItem.cTreeID].sortMoveAjax,data:a,dataType:"json",success:function(e){if(e.success){if(r=="up"){n.parent().after(t)}else if(r=="down"){n.parent().before(t)}nsalert("目录移动成功")}else{nsalert("目录移动失败，错误信息："+e.msg,"error")}},error:function(e){nsalert("目录移动失败，错误信息：:"+date.msg)}})}else{var o;if(r=="up"){o="已经是第一个，无法上移"}else if(r=="down"){o="已经是最后一个，无法下移"}nsalert(o,"warning")}};nsTree.edit=function(){var e=nsdialog.getFormJson();if(e==false){nsalert("您填写的数据不完整");return false}var r=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyID;var n=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyParent;var t=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyText;e[r]=nsTree.currentItem.cItemID;var a=nsTree.getSearchDom(nsTree.currentItem.cTreeID,nsTree.currentItem.cItemID);if(typeof a=="undefined"){a=$("#"+nsTree.currentItem.cTreeID)}$.ajax({type:nsTree.config[nsTree.currentItem.cTreeID].ajaxMethod,url:nsTree.config[nsTree.currentItem.cTreeID].editAjax,data:e,dataType:"json",success:function(r){if(r.success){nsTree.getSearchJson(nsTree.json[nsTree.currentItem.cTreeID],nsTree.currentItem.cItemID,nsTree.currentItem.cTreeID);var n=nsTree.searchJson;$.each(e,function(e,r){if(e!=nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyID){n[e]=r}});var a=nsTree.getSearchDom(nsTree.currentItem.cTreeID,nsTree.currentItem.cItemID);var o=e[t];$(a).attr("data-name",o);$(a).children("div.list-content").children("div.list-label").text(o);nsTree.currentItem.cItemName=e[t];var s=e[nsTree.config[nsTree.currentItem.cTreeID].controlForm.keyOrderID];s=Number(s-1);var l=$('li[data-id="'+nsTree.currentItem.cItemID+'"]');var i=nsTree.getDomData(nsTree.currentItem.cItemID,nsTree.currentItem.cTreeID);if(i.order>s){l.insertBefore($(l).parent().children("li")[s])}else if(i.order<s){l.insertAfter($(l).parent().children("li")[s])}else{}if(typeof nsTree.config[nsTree.currentItem.cTreeID].editHandler!="undefined"){var d=nsTree.config[nsTree.currentItem.cTreeID].editHandler;d(r)}nsalert("目录修改成功");nsdialog.hide()}else{nsalert("目录修改失败:"+date.msg)}},error:function(e){nsalert("目录修改失败，请重试或者刷新页面，错误代码:"+date.msg)}})};nsTree.initDialog=function(e){if(e.dialogConfig){this.dialogDeleteConfig=dialogConfig.dialogDeleteConfig;this.dialogEditConfig=dialogConfig.dialogEditConfig;this.dialogAddConfig=dialogConfig.dialogAddConfig}else{this.dialogDeleteConfig={id:"plane-deletemenus",title:"删除目录项",size:"s",form:[{note:"您即将删除该目录，该目录下的子目录也会受到影响。<br> 此次操作将不可恢复，请确认您的选择"},{html:"<hr>"}],btns:[{text:"确认",handler:"nsTree.del"}]};this.dialogEditConfig={id:"plane-editmenus",title:"修改目录项",size:"s",form:[],btns:[{text:"确认",handler:"nsTree.edit"}]};this.dialogAddConfig={id:"plane-addmenus",title:"新增目录项",size:"s",form:[],btns:[{text:"确认",handler:"nsTree.add"}]}}var r={id:e.controlForm.keyText,label:langTree.dialog.nodeNameLabel,type:"text",rules:"required",value:nsTree.getDialogName};var n={id:e.controlForm.keyOrderID,label:langTree.dialog.nodeSortLable,type:"text",rules:"required number",value:nsTree.getDialogOrder};nsTree.dialogEditConfig.form.push(r);nsTree.dialogEditConfig.form.push(n);var t={id:e.controlForm.keyText,label:langTree.dialog.nodeDeleteNameLable,type:"text",readonly:true,value:nsTree.getDialogName};nsTree.dialogDeleteConfig.form.push(t);var a={id:e.controlForm.keyText,label:langTree.dialog.nodeAddNameLable,type:"text",rules:"required"};var o={id:"addParentName",label:langTree.dialog.nodeParentLable,type:"text",readonly:true,value:function(){return nsTree.dialogAddValue("parentName")}};var s={id:e.controlForm.keyParent,type:"hidden",value:function(){return nsTree.dialogAddValue("parentId")}};var l={id:e.controlForm.keyOrderID,label:langTree.dialog.nodeSortLable,type:"text",value:function(){return nsTree.dialogAddValue("sortId")}};nsTree.dialogAddConfig.form.push(o);nsTree.dialogAddConfig.form.push(s);nsTree.dialogAddConfig.form.push(a);nsTree.dialogAddConfig.form.push(l)};nsTree.dialogDelete=function(){if($.isEmptyObject(nsTree.currentItem)||nsTree.currentItem.cItemID==""){if($.isEmptyObject(nsTree.multipleSelectJson)){nsalert(langTree.dialog.deleteEmptyText)}else{var e=0;var r;$.each(nsTree.multipleSelectJson,function(n,t){e++;r=n});if(e=1){nsTree.currentItem=nsTree.multipleSelectJson[r]}else{nsalert(langTree.dialog.deleteMoreNodeText)}}}else{popupBox.initShow(nsTree.dialogDeleteConfig)}};nsTree.dialogEdit=function(){if($.isEmptyObject(nsTree.currentItem)||nsTree.currentItem.cItemID==""){nsalert("请先选择要修改的目录树")}else{popupBox.initShow(nsTree.dialogEditConfig)}};